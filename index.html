import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, deleteDoc, query, where } from 'firebase/firestore';

// Context for Firebase and User data
const AppContext = createContext();

// Custom Modal Component (replaces alert/confirm)
const CustomModal = ({ isOpen, title, message, onClose, onConfirm, showConfirmButton = false }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-right" dir="rtl">
                <h3 className="text-lg font-semibold mb-4 text-gray-800">{title}</h3>
                <p className="text-gray-700 mb-6">{message}</p>
                <div className="flex justify-end space-x-2">
                    <button
                        onClick={onClose}
                        className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors duration-200"
                    >
                        ╪е╪║┘Д╪з┘В
                    </button>
                    {showConfirmButton && (
                        <button
                            onClick={onConfirm}
                            className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200"
                        >
                            ╪к╪г┘Г┘К╪п
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};

// Main App Component
function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard', 'cars', 'dailyCheck', 'emergency', 'monthly', 'annualReport'
    const [cars, setCars] = useState([]);
    const [maintenanceRecords, setMaintenanceRecords] = useState([]);
    const [selectedCar, setSelectedCar] = useState(null);

    // Modal state
    const [modal, setModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        onClose: () => setModal({ ...modal, isOpen: false }),
        onConfirm: null,
        showConfirmButton: false,
    });

    // Initialize Firebase
    useEffect(() => {
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Please provide it via __firebase_config.");
                setModal({
                    isOpen: true,
                    title: '╪о╪╖╪г ┘Б┘К ╪з┘Д╪к┘З┘К╪ж╪й',
                    message: '┘Д┘Е ┘К╪к┘Е ╪к┘И┘Б┘К╪▒ ╪е╪╣╪п╪з╪п╪з╪к Firebase ╪и╪┤┘Г┘Д ╪╡╪н┘К╪н. ┘К╪▒╪м┘Й ╪з┘Д╪к╪н┘В┘В ┘Е┘Ж ╪з┘Д╪к┘Г┘И┘К┘Ж.',
                });
                return;
            }

            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);

            setDb(firestore);
            setAuth(authInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    // Sign in anonymously if no user is authenticated and no custom token is available
                    if (typeof __initial_auth_token === 'undefined' || !__initial_auth_token) {
                        await signInAnonymously(authInstance);
                    }
                }
                setIsAuthReady(true);
            });

            // Attempt to sign in with custom token if available
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (authInstance && initialAuthToken) {
                signInWithCustomToken(authInstance, initialAuthToken)
                    .then(() => console.log("Signed in with custom token"))
                    .catch((error) => {
                        console.error("Error signing in with custom token:", error);
                        // Fallback to anonymous if custom token fails
                        signInAnonymously(authInstance)
                            .then(() => console.log("Signed in anonymously after custom token failure"))
                            .catch(anonError => console.error("Error signing in anonymously:", anonError));
                    });
            } else if (authInstance) {
                // If no custom token, sign in anonymously
                signInAnonymously(authInstance)
                    .then(() => console.log("Signed in anonymously"))
                    .catch(anonError => console.error("Error signing in anonymously:", anonError));
            }

            return () => unsubscribe();
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
            setModal({
                isOpen: true,
                title: '╪о╪╖╪г ┘Б╪з╪п╪н',
                message: `┘Б╪┤┘Д ╪к┘З┘К╪ж╪й Firebase: ${error.message}. ┘К╪▒╪м┘Й ╪з┘Д╪к╪н┘В┘В ┘Е┘Ж ╪е╪╣╪п╪з╪п╪з╪к┘Г.`,
            });
        }
    }, []);

    // Fetch Cars and Maintenance Records
    useEffect(() => {
        if (!db || !isAuthReady || !userId) return;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Listen for cars collection (public data)
        const carsRef = collection(db, `artifacts/${appId}/public/data/cars`);
        const unsubscribeCars = onSnapshot(carsRef, (snapshot) => {
            const carsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setCars(carsData);
        }, (error) => {
            console.error("Error fetching cars:", error);
            setModal({
                isOpen: true,
                title: '╪о╪╖╪г ┘Б┘К ╪м┘Д╪и ╪з┘Д╪и┘К╪з┘Ж╪з╪к',
                message: `┘Б╪┤┘Д ╪м┘Д╪и ╪и┘К╪з┘Ж╪з╪к ╪з┘Д╪│┘К╪з╪▒╪з╪к: ${error.message}`,
            });
        });

        // Listen for maintenance records (private data)
        const maintenanceRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
        const unsubscribeMaintenance = onSnapshot(maintenanceRef, (snapshot) => {
            const recordsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMaintenanceRecords(recordsData);
        }, (error) => {
            console.error("Error fetching maintenance records:", error);
            setModal({
                isOpen: true,
                title: '╪о╪╖╪г ┘Б┘К ╪м┘Д╪и ╪з┘Д╪и┘К╪з┘Ж╪з╪к',
                message: `┘Б╪┤┘Д ╪м┘Д╪и ╪│╪м┘Д╪з╪к ╪з┘Д╪╡┘К╪з┘Ж╪й: ${error.message}`,
            });
        });

        return () => {
            unsubscribeCars();
            unsubscribeMaintenance();
        };
    }, [db, isAuthReady, userId]);

    const showMessage = (title, message, showConfirm = false, onConfirm = null) => {
        setModal({
            isOpen: true,
            title,
            message,
            onClose: () => setModal({ ...modal, isOpen: false }),
            onConfirm,
            showConfirmButton: showConfirm,
        });
    };

    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-center p-6 bg-white rounded-lg shadow-md">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"></div>
                    <p className="text-gray-700">╪м╪з╪▒┘К ╪к╪н┘Е┘К┘Д ╪з┘Д╪к╪╖╪и┘К┘В...</p>
                </div>
            </div>
        );
    }

    return (
        <AppContext.Provider value={{ db, auth, userId, cars, maintenanceRecords, setCars, setMaintenanceRecords, showMessage, selectedCar, setSelectedCar }}>
            <div className="min-h-screen bg-gray-100 font-sans text-gray-900" dir="rtl">
                <CustomModal {...modal} />

                <nav className="bg-gradient-to-r from-blue-600 to-blue-800 p-4 shadow-lg">
                    <div className="container mx-auto flex flex-wrap justify-between items-center">
                        <h1 className="text-white text-2xl font-bold rounded-md px-3 py-1">┘Ж╪╕╪з┘Е ╪е╪п╪з╪▒╪й ╪╡┘К╪з┘Ж╪й ╪з┘Д╪│┘К╪з╪▒╪з╪к</h1>
                        <div className="flex space-x-4 space-x-reverse mt-2 md:mt-0">
                            <NavItem onClick={() => setCurrentView('dashboard')} isActive={currentView === 'dashboard'}>╪з┘Д╪▒╪ж┘К╪│┘К╪й</NavItem>
                            <NavItem onClick={() => setCurrentView('cars')} isActive={currentView === 'cars'}>╪з┘Д╪│┘К╪з╪▒╪з╪к</NavItem>
                            <NavItem onClick={() => setCurrentView('dailyCheck')} isActive={currentView === 'dailyCheck'}>┘Б╪н╪╡ ┘К┘И┘Е┘К</NavItem>
                            <NavItem onClick={() => setCurrentView('emergency')} isActive={currentView === 'emergency'}>╪╖┘Д╪и ╪е╪╡┘Д╪з╪н ╪╖╪з╪▒╪ж</NavItem>
                            <NavItem onClick={() => setCurrentView('monthly')} isActive={currentView === 'monthly'}>╪╡┘К╪з┘Ж╪й ╪п┘И╪▒┘К╪й</NavItem>
                            <NavItem onClick={() => setCurrentView('annualReport')} isActive={currentView === 'annualReport'}>╪к┘В╪з╪▒┘К╪▒ ╪│┘Ж┘И┘К╪й</NavItem>
                        </div>
                        <div className="text-white text-sm mt-2 md:mt-0">
                            ┘Е╪╣╪▒┘Б ╪з┘Д┘Е╪│╪к╪о╪п┘Е: {userId}
                        </div>
                    </div>
                </nav>

                <main className="container mx-auto p-6">
                    {currentView === 'dashboard' && <Dashboard />}
                    {currentView === 'cars' && <CarManagement />}
                    {currentView === 'dailyCheck' && <DailyCheckForm />}
                    {currentView === 'emergency' && <EmergencyRequestForm />}
                    {currentView === 'monthly' && <MonthlyMaintenanceForm />}
                    {currentView === 'annualReport' && <AnnualReport />}
                </main>
            </div>
        </AppContext.Provider>
    );
}

// Navigation Item Component
const NavItem = ({ children, onClick, isActive }) => (
    <button
        onClick={onClick}
        className={`px-4 py-2 rounded-md transition-all duration-300 ${isActive ? 'bg-blue-500 text-white shadow-md' : 'text-blue-100 hover:bg-blue-700 hover:text-white'}`}
    >
        {children}
    </button>
);

// Dashboard Component
const Dashboard = () => {
    const { cars, maintenanceRecords } = useContext(AppContext);

    // Calculate upcoming maintenance (example: next 30 days for monthly/quarterly/annual)
    const upcomingMaintenance = maintenanceRecords.filter(record => {
        const nextDate = record.nextMaintenanceDate ? new Date(record.nextMaintenanceDate) : null;
        if (!nextDate) return false;
        const today = new Date();
        const thirtyDaysLater = new Date();
        thirtyDaysLater.setDate(today.getDate() + 30);
        return nextDate >= today && nextDate <= thirtyDaysLater;
    }).sort((a, b) => new Date(a.nextMaintenanceDate) - new Date(b.nextMaintenanceDate));

    // Calculate open emergency requests
    const openEmergencyRequests = maintenanceRecords.filter(record =>
        record.type === 'emergency' && record.status !== '╪к┘Е ╪з┘Д╪е╪╡┘Д╪з╪н'
    );

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <DashboardCard title="╪е╪м┘Е╪з┘Д┘К ╪з┘Д╪│┘К╪з╪▒╪з╪к" value={cars.length} icon="ЁЯЪЧ" />
            <DashboardCard title="╪╡┘К╪з┘Ж╪й ┘В╪з╪п┘Е╪й (30 ┘К┘И┘Е┘Л╪з)" value={upcomingMaintenance.length} icon="я┐╜я╕П" />
            <DashboardCard title="╪╖┘Д╪и╪з╪к ╪е╪╡┘Д╪з╪н ┘Е┘Б╪к┘И╪н╪й" value={openEmergencyRequests.length} icon="тЪая╕П" />

            <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-xl font-semibold mb-4 text-gray-800">╪з┘Д╪╡┘К╪з┘Ж╪й ╪з┘Д┘В╪з╪п┘Е╪й</h2>
                {upcomingMaintenance.length > 0 ? (
                    <ul className="space-y-3">
                        {upcomingMaintenance.map(record => (
                            <li key={record.id} className="p-3 bg-blue-50 rounded-md border border-blue-200 flex justify-between items-center text-sm">
                                <div>
                                    <p className="font-medium">╪з┘Д╪│┘К╪з╪▒╪й: {record.carNumber}</p>
                                    <p>╪з┘Д┘Ж┘И╪╣: {record.type}</p>
                                    <p>╪з┘Д┘Е┘И╪╣╪п: {new Date(record.nextMaintenanceDate).toLocaleDateString('ar-SA')}</p>
                                </div>
                                <span className="text-blue-600 font-bold">┘В╪▒┘К╪и┘Л╪з</span>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <p className="text-gray-600">┘Д╪з ╪к┘И╪м╪п ╪╡┘К╪з┘Ж╪й ┘В╪з╪п┘Е╪й ╪о┘Д╪з┘Д 30 ┘К┘И┘Е┘Л╪з.</p>
                )}
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-xl font-semibold mb-4 text-gray-800">╪╖┘Д╪и╪з╪к ╪з┘Д╪е╪╡┘Д╪з╪н ╪з┘Д┘Е┘Б╪к┘И╪н╪й</h2>
                {openEmergencyRequests.length > 0 ? (
                    <ul className="space-y-3">
                        {openEmergencyRequests.map(record => (
                            <li key={record.id} className="p-3 bg-yellow-50 rounded-md border border-yellow-200 text-sm">
                                <p className="font-medium">╪з┘Д╪│┘К╪з╪▒╪й: {record.carNumber}</p>
                                <p>╪з┘Д╪╣╪╖┘Д: {record.description}</p>
                                <p>╪з┘Д╪н╪з┘Д╪й: <span className="font-semibold text-yellow-700">{record.status}</span></p>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <p className="text-gray-600">┘Д╪з ╪к┘И╪м╪п ╪╖┘Д╪и╪з╪к ╪е╪╡┘Д╪з╪н ┘Е┘Б╪к┘И╪н╪й ╪н╪з┘Д┘К┘Л╪з.</p>
                )}
            </div>
        </div>
    );
};

// Dashboard Card Component
const DashboardCard = ({ title, value, icon }) => (
    <div className="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
        <div>
            <h3 className="text-lg font-semibold text-gray-700">{title}</h3>
            <p className="text-3xl font-bold text-blue-600">{value}</p>
        </div>
        <span className="text-5xl">{icon}</span>
    </div>
);

// Car Management Component
const CarManagement = () => {
    const { cars, showMessage, db, setCars } = useContext(AppContext);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const [isAddingCar, setIsAddingCar] = useState(false);
    const [newCarData, setNewCarData] = useState({
        carNumber: '', model: '', year: '', fuelType: '', plateNumber: '', owner: '', currentMileage: 0
    });
    const [editingCar, setEditingCar] = useState(null); // State to hold car being edited

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setNewCarData(prev => ({ ...prev, [name]: value }));
    };

    const handleAddCar = async (e) => {
        e.preventDefault();
        if (!db) {
            showMessage('╪о╪╖╪г', '┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к ╪║┘К╪▒ ┘Е┘З┘К╪г╪й.');
            return;
        }

        if (!newCarData.carNumber || !newCarData.model || !newCarData.plateNumber) {
            showMessage('╪о╪╖╪г', '╪з┘Д╪▒╪м╪з╪б ┘Е┘Д╪б ╪з┘Д╪н┘В┘И┘Д ╪з┘Д┘Е╪╖┘Д┘И╪и╪й (╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й╪М ╪з┘Д┘Е┘И╪п┘К┘Д╪М ╪▒┘В┘Е ╪з┘Д┘Д┘И╪н╪й).');
            return;
        }

        try {
            const carsCollectionRef = collection(db, `artifacts/${appId}/public/data/cars`);
            await addDoc(carsCollectionRef, newCarData);
            showMessage('┘Ж╪м╪з╪н', '╪к┘Е╪к ╪е╪╢╪з┘Б╪й ╪з┘Д╪│┘К╪з╪▒╪й ╪и┘Ж╪м╪з╪н!');
            setNewCarData({ carNumber: '', model: '', year: '', fuelType: '', plateNumber: '', owner: '', currentMileage: 0 });
            setIsAddingCar(false);
        } catch (error) {
            console.error("Error adding car:", error);
            showMessage('╪о╪╖╪г', `┘Б╪┤┘Д ╪е╪╢╪з┘Б╪й ╪з┘Д╪│┘К╪з╪▒╪й: ${error.message}`);
        }
    };

    const handleEditCar = (car) => {
        setEditingCar(car);
        setNewCarData(car); // Populate form with existing car data
        setIsAddingCar(true); // Show the form for editing
    };

    const handleUpdateCar = async (e) => {
        e.preventDefault();
        if (!db || !editingCar) {
            showMessage('╪о╪╖╪г', '┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к ╪║┘К╪▒ ┘Е┘З┘К╪г╪й ╪г┘И ┘Д╪з ╪к┘И╪м╪п ╪│┘К╪з╪▒╪й ┘Д┘Д╪к╪н╪п┘К╪л.');
            return;
        }

        try {
            const carDocRef = doc(db, `artifacts/${appId}/public/data/cars`, editingCar.id);
            await updateDoc(carDocRef, newCarData);
            showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪к╪н╪п┘К╪л ╪и┘К╪з┘Ж╪з╪к ╪з┘Д╪│┘К╪з╪▒╪й ╪и┘Ж╪м╪з╪н!');
            setEditingCar(null);
            setNewCarData({ carNumber: '', model: '', year: '', fuelType: '', plateNumber: '', owner: '', currentMileage: 0 });
            setIsAddingCar(false);
        } catch (error) {
            console.error("Error updating car:", error);
            showMessage('╪о╪╖╪г', `┘Б╪┤┘Д ╪к╪н╪п┘К╪л ╪з┘Д╪│┘К╪з╪▒╪й: ${error.message}`);
        }
    };

    const handleDeleteCar = (carId) => {
        showMessage(
            '╪к╪г┘Г┘К╪п ╪з┘Д╪н╪░┘Б',
            '┘З┘Д ╪г┘Ж╪к ┘Е╪к╪г┘Г╪п ╪г┘Ж┘Г ╪к╪▒┘К╪п ╪н╪░┘Б ┘З╪░┘З ╪з┘Д╪│┘К╪з╪▒╪й╪Я ╪│┘К╪к┘Е ╪н╪░┘Б ╪м┘Е┘К╪╣ ╪│╪м┘Д╪з╪к ╪з┘Д╪╡┘К╪з┘Ж╪й ╪з┘Д┘Е╪к╪╣┘Д┘В╪й ╪и┘З╪з ╪г┘К╪╢┘Л╪з.',
            true,
            async () => {
                try {
                    // Delete car document
                    const carDocRef = doc(db, `artifacts/${appId}/public/data/cars`, carId);
                    await deleteDoc(carDocRef);

                    // Optional: Delete related maintenance records (more complex query needed for private data)
                    // For simplicity, this example only deletes the car.
                    // In a real app, you'd query and delete all maintenance records linked to this carId.

                    showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪н╪░┘Б ╪з┘Д╪│┘К╪з╪▒╪й ╪и┘Ж╪м╪з╪н!');
                    setCars(prev => prev.filter(car => car.id !== carId)); // Update local state
                } catch (error) {
                    console.error("Error deleting car:", error);
                    showMessage('╪о╪╖╪г', `┘Б╪┤┘Д ╪н╪░┘Б ╪з┘Д╪│┘К╪з╪▒╪й: ${error.message}`);
                }
            }
        );
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">╪е╪п╪з╪▒╪й ╪з┘Д╪│┘К╪з╪▒╪з╪к</h2>

            <button
                onClick={() => { setIsAddingCar(!isAddingCar); setEditingCar(null); setNewCarData({ carNumber: '', model: '', year: '', fuelType: '', plateNumber: '', owner: '', currentMileage: 0 }); }}
                className="mb-6 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md"
            >
                {isAddingCar ? '╪е┘Д╪║╪з╪б ╪е╪╢╪з┘Б╪й/╪к╪╣╪п┘К┘Д ╪│┘К╪з╪▒╪й' : '╪е╪╢╪з┘Б╪й ╪│┘К╪з╪▒╪й ╪м╪п┘К╪п╪й'}
            </button>

            {isAddingCar && (
                <form onSubmit={editingCar ? handleUpdateCar : handleAddCar} className="mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                    <h3 className="text-lg font-semibold mb-4 text-gray-800">{editingCar ? '╪к╪╣╪п┘К┘Д ╪и┘К╪з┘Ж╪з╪к ╪з┘Д╪│┘К╪з╪▒╪й' : '╪е╪╢╪з┘Б╪й ╪│┘К╪з╪▒╪й ╪м╪п┘К╪п╪й'}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <InputField label="╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й" name="carNumber" value={newCarData.carNumber} onChange={handleInputChange} required />
                        <InputField label="╪з┘Д┘Е┘И╪п┘К┘Д" name="model" value={newCarData.model} onChange={handleInputChange} required />
                        <InputField label="╪│┘Ж╪й ╪з┘Д╪╡┘Ж╪╣" name="year" type="number" value={newCarData.year} onChange={handleInputChange} />
                        <InputField label="┘Ж┘И╪╣ ╪з┘Д┘И┘В┘И╪п" name="fuelType" value={newCarData.fuelType} onChange={handleInputChange} />
                        <InputField label="╪▒┘В┘Е ╪з┘Д┘Д┘И╪н╪й" name="plateNumber" value={newCarData.plateNumber} onChange={handleInputChange} required />
                        <InputField label="╪з┘Д┘Е╪з┘Д┘Г/╪з┘Д┘Е╪│╪к╪о╪п┘Е ╪з┘Д╪г╪│╪з╪│┘К" name="owner" value={newCarData.owner} onChange={handleInputChange} />
                        <InputField label="╪╣╪п╪з╪п ╪з┘Д┘Е╪│╪з┘Б╪з╪к ╪з┘Д╪н╪з┘Д┘К (┘Г┘Е)" name="currentMileage" type="number" value={newCarData.currentMileage} onChange={handleInputChange} />
                    </div>
                    <button
                        type="submit"
                        className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 shadow-md"
                    >
                        {editingCar ? '╪к╪н╪п┘К╪л ╪з┘Д╪│┘К╪з╪▒╪й' : '╪е╪╢╪з┘Б╪й ╪з┘Д╪│┘К╪з╪▒╪й'}
                    </button>
                </form>
            )}

            <h3 className="text-lg font-semibold mb-4 text-gray-800">┘В╪з╪ж┘Е╪й ╪з┘Д╪│┘К╪з╪▒╪з╪к ╪з┘Д┘Е╪│╪м┘Д╪й</h3>
            {cars.length === 0 ? (
                <p className="text-gray-600">┘Д╪з ╪к┘И╪м╪п ╪│┘К╪з╪▒╪з╪к ┘Е╪│╪м┘Д╪й ╪и╪╣╪п. ╪з╪и╪п╪г ╪и╪е╪╢╪з┘Б╪й ╪│┘К╪з╪▒╪й ╪м╪п┘К╪п╪й!</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead className="bg-gray-100">
                            <tr>
                                <th className="py-3 px-4 border-b text-right">╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д┘Е┘И╪п┘К┘Д</th>
                                <th className="py-3 px-4 border-b text-right">╪▒┘В┘Е ╪з┘Д┘Д┘И╪н╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪╣╪п╪з╪п ╪з┘Д┘Е╪│╪з┘Б╪з╪к</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д╪е╪м╪▒╪з╪б╪з╪к</th>
                            </tr>
                        </thead>
                        <tbody>
                            {cars.map(car => (
                                <tr key={car.id} className="hover:bg-gray-50 transition-colors duration-150">
                                    <td className="py-3 px-4 border-b">{car.carNumber}</td>
                                    <td className="py-3 px-4 border-b">{car.model}</td>
                                    <td className="py-3 px-4 border-b">{car.plateNumber}</td>
                                    <td className="py-3 px-4 border-b">{car.currentMileage || '╪║┘К╪▒ ┘Е╪н╪п╪п'} ┘Г┘Е</td>
                                    <td className="py-3 px-4 border-b">
                                        <button
                                            onClick={() => handleEditCar(car)}
                                            className="ml-2 px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors duration-200 text-sm"
                                        >
                                            ╪к╪╣╪п┘К┘Д
                                        </button>
                                        <button
                                            onClick={() => handleDeleteCar(car.id)}
                                            className="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 text-sm"
                                        >
                                            ╪н╪░┘Б
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// Form Input Field Component
const InputField = ({ label, name, value, onChange, type = 'text', required = false }) => (
    <div>
        <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">
            {label} {required && <span className="text-red-500">*</span>}
        </label>
        <input
            type={type}
            id={name}
            name={name}
            value={value}
            onChange={onChange}
            required={required}
            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
        />
    </div>
);

// Form Select Field Component
const SelectField = ({ label, name, value, onChange, options, required = false }) => (
    <div>
        <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">
            {label} {required && <span className="text-red-500">*</span>}
        </label>
        <select
            id={name}
            name={name}
            value={value}
            onChange={onChange}
            required={required}
            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white"
        >
            <option value="">╪з╪о╪к╪▒...</option>
            {options.map((option, index) => (
                <option key={index} value={option.value || option}>{option.label || option}</option>
            ))}
        </select>
    </div>
);

// Daily Check Form Component
const DailyCheckForm = () => {
    const { db, userId, cars, showMessage } = useContext(AppContext);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const [formData, setFormData] = useState({
        carId: '',
        carNumber: '', // To store car number for easier display/query
        date: new Date().toISOString().split('T')[0],
        oilCheck: false,
        tirePressure: '',
        lightsCheck: false,
        brakesCheck: false,
        coolingFluidsCheck: false,
        cleanlinessCheck: false,
        notes: '',
        driverSignature: '',
    });

    const handleCarSelect = (e) => {
        const selectedCarId = e.target.value;
        const car = cars.find(c => c.id === selectedCarId);
        setFormData(prev => ({
            ...prev,
            carId: selectedCarId,
            carNumber: car ? car.carNumber : '',
        }));
    };

    const handleInputChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: type === 'checkbox' ? checked : value,
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage('╪о╪╖╪г', '┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к ╪г┘И ┘Е╪╣╪▒┘Б ╪з┘Д┘Е╪│╪к╪о╪п┘Е ╪║┘К╪▒ ┘Е╪к╪з╪н.');
            return;
        }
        if (!formData.carId || !formData.date || !formData.driverSignature) {
            showMessage('╪о╪╖╪г', '╪з┘Д╪▒╪м╪з╪б ┘Е┘Д╪б ╪з┘Д╪н┘В┘И┘Д ╪з┘Д┘Е╪╖┘Д┘И╪и╪й (╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й╪М ╪з┘Д╪к╪з╪▒┘К╪о╪М ╪к┘И┘В┘К╪╣ ╪з┘Д╪│╪з╪ж┘В).');
            return;
        }

        try {
            const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
            await addDoc(maintenanceCollectionRef, {
                ...formData,
                type: '╪╡┘К╪з┘Ж╪й ┘К┘И┘Е┘К╪й',
                timestamp: new Date(),
            });
            showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪к╪│╪м┘К┘Д ╪з┘Д┘Б╪н╪╡ ╪з┘Д┘К┘И┘Е┘К ╪и┘Ж╪м╪з╪н!');
            setFormData({
                carId: '',
                carNumber: '',
                date: new Date().toISOString().split('T')[0],
                oilCheck: false,
                tirePressure: '',
                lightsCheck: false,
                brakesCheck: false,
                coolingFluidsCheck: false,
                cleanlinessCheck: false,
                notes: '',
                driverSignature: '',
            });
        } catch (error) {
            console.error("Error adding daily check:", error);
            showMessage('╪о╪╖╪г', `┘Б╪┤┘Д ╪к╪│╪м┘К┘Д ╪з┘Д┘Б╪н╪╡ ╪з┘Д┘К┘И┘Е┘К: ${error.message}`);
        }
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">┘Ж┘Е┘И╪░╪м ╪з┘Д┘Б╪н╪╡ ╪з┘Д┘К┘И┘Е┘К ┘Д┘Д╪│┘К╪з╪▒╪й</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
                <SelectField
                    label="╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й"
                    name="carId"
                    value={formData.carId}
                    onChange={handleCarSelect}
                    options={cars.map(car => ({ value: car.id, label: car.carNumber }))}
                    required
                />
                <InputField label="╪з┘Д╪к╪з╪▒┘К╪о" name="date" type="date" value={formData.date} onChange={handleInputChange} required />

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <CheckboxField label="┘Б╪н╪╡ ╪з┘Д╪▓┘К╪к" name="oilCheck" checked={formData.oilCheck} onChange={handleInputChange} />
                    <InputField label="╪╢╪║╪╖ ╪з┘Д╪е╪╖╪з╪▒╪з╪к" name="tirePressure" value={formData.tirePressure} onChange={handleInputChange} placeholder="┘Е╪л╪з┘Д: 32 PSI" />
                    <CheckboxField label="┘Б╪н╪╡ ╪з┘Д╪е╪╢╪з╪б╪й" name="lightsCheck" checked={formData.lightsCheck} onChange={handleInputChange} />
                    <CheckboxField label="┘Б╪н╪╡ ╪з┘Д┘Б╪▒╪з┘Е┘Д" name="brakesCheck" checked={formData.brakesCheck} onChange={handleInputChange} />
                    <CheckboxField label="┘Б╪н╪╡ ╪│┘И╪з╪ж┘Д ╪з┘Д╪к╪и╪▒┘К╪п" name="coolingFluidsCheck" checked={formData.coolingFluidsCheck} onChange={handleInputChange} />
                    <CheckboxField label="┘Ж╪╕╪з┘Б╪й ╪з┘Д╪│┘К╪з╪▒╪й" name="cleanlinessCheck" checked={formData.cleanlinessCheck} onChange={handleInputChange} />
                </div>

                <InputField label="┘Е┘Д╪з╪н╪╕╪з╪к" name="notes" value={formData.notes} onChange={handleInputChange} type="textarea" />
                <InputField label="╪к┘И┘В┘К╪╣ ╪з┘Д╪│╪з╪ж┘В" name="driverSignature" value={formData.driverSignature} onChange={handleInputChange} required />

                <button
                    type="submit"
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md"
                >
                    ╪к╪│╪м┘К┘Д ╪з┘Д┘Б╪н╪╡
                </button>
            </form>
        </div>
    );
};

// Checkbox Field Component
const CheckboxField = ({ label, name, checked, onChange }) => (
    <div className="flex items-center">
        <input
            type="checkbox"
            id={name}
            name={name}
            checked={checked}
            onChange={onChange}
            className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
        />
        <label htmlFor={name} className="mr-2 text-sm font-medium text-gray-700">
            {label}
        </label>
    </div>
);


// Emergency Request Form Component
const EmergencyRequestForm = () => {
    const { db, userId, cars, showMessage } = useContext(AppContext);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const [formData, setFormData] = useState({
        carId: '',
        carNumber: '',
        date: new Date().toISOString().split('T')[0],
        description: '',
        priority: '┘Е╪к┘И╪│╪╖', // '╪╣╪з╪м┘Д', '┘Е╪к┘И╪│╪╖', '┘Е┘Ж╪о┘Б╪╢'
        status: '┘В┘К╪п ╪з┘Д╪з┘Ж╪к╪╕╪з╪▒', // '┘В┘К╪п ╪з┘Д╪з┘Ж╪к╪╕╪з╪▒', '┘В┘К╪п ╪з┘Д╪е╪╡┘Д╪з╪н', '╪к┘Е ╪з┘Д╪е╪╡┘Д╪з╪н', '╪и╪з┘Ж╪к╪╕╪з╪▒ ┘В╪╖╪╣ ╪з┘Д╪║┘К╪з╪▒'
        estimatedCost: 0,
        actualCost: 0,
        signature: '',
    });

    const [editingRequest, setEditingRequest] = useState(null);

    const handleCarSelect = (e) => {
        const selectedCarId = e.target.value;
        const car = cars.find(c => c.id === selectedCarId);
        setFormData(prev => ({
            ...prev,
            carId: selectedCarId,
            carNumber: car ? car.carNumber : '',
        }));
    };

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage('╪о╪╖╪г', '┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к ╪г┘И ┘Е╪╣╪▒┘Б ╪з┘Д┘Е╪│╪к╪о╪п┘Е ╪║┘К╪▒ ┘Е╪к╪з╪н.');
            return;
        }
        if (!formData.carId || !formData.description || !formData.signature) {
            showMessage('╪о╪╖╪г', '╪з┘Д╪▒╪м╪з╪б ┘Е┘Д╪б ╪з┘Д╪н┘В┘И┘Д ╪з┘Д┘Е╪╖┘Д┘И╪и╪й (╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й╪М ┘И╪╡┘Б ╪з┘Д╪╣╪╖┘Д╪М ╪з┘Д╪к┘И┘В┘К╪╣).');
            return;
        }

        try {
            const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
            if (editingRequest) {
                const docRef = doc(maintenanceCollectionRef, editingRequest.id);
                await updateDoc(docRef, { ...formData, timestamp: new Date() });
                showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪к╪н╪п┘К╪л ╪╖┘Д╪и ╪з┘Д╪е╪╡┘Д╪з╪н ╪и┘Ж╪м╪з╪н!');
                setEditingRequest(null);
            } else {
                await addDoc(maintenanceCollectionRef, {
                    ...formData,
                    type: '╪╡┘К╪з┘Ж╪й ╪╖╪з╪▒╪ж╪й',
                    timestamp: new Date(),
                });
                showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪к╪│╪м┘К┘Д ╪╖┘Д╪и ╪з┘Д╪е╪╡┘Д╪з╪н ╪з┘Д╪╖╪з╪▒╪ж ╪и┘Ж╪м╪з╪н!');
            }
            setFormData({
                carId: '', carNumber: '', date: new Date().toISOString().split('T')[0],
                description: '', priority: '┘Е╪к┘И╪│╪╖', status: '┘В┘К╪п ╪з┘Д╪з┘Ж╪к╪╕╪з╪▒',
                estimatedCost: 0, actualCost: 0, signature: ''
            });
        } catch (error) {
            console.error("Error submitting emergency request:", error);
            showMessage('╪о╪╖╪г', `┘Б╪┤┘Д ╪к╪│╪м┘К┘Д ╪╖┘Д╪и ╪з┘Д╪е╪╡┘Д╪з╪н ╪з┘Д╪╖╪з╪▒╪ж: ${error.message}`);
        }
    };

    const handleEditRequest = (request) => {
        setEditingRequest(request);
        setFormData(request);
    };

    const handleDeleteRequest = (requestId) => {
        showMessage(
            '╪к╪г┘Г┘К╪п ╪з┘Д╪н╪░┘Б',
            '┘З┘Д ╪г┘Ж╪к ┘Е╪к╪г┘Г╪п ╪г┘Ж┘Г ╪к╪▒┘К╪п ╪н╪░┘Б ╪╖┘Д╪и ╪з┘Д╪е╪╡┘Д╪з╪н ┘З╪░╪з╪Я',
            true,
            async () => {
                try {
                    const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
                    const docRef = doc(maintenanceCollectionRef, requestId);
                    await deleteDoc(docRef);
                    showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪н╪░┘Б ╪╖┘Д╪и ╪з┘Д╪е╪╡┘Д╪з╪н ╪и┘Ж╪м╪з╪н!');
                } catch (error) {
                    console.error("Error deleting emergency request:", error);
                    showMessage('╪о╪╖╪г', `┘Б╪┤┘Д ╪н╪░┘Б ╪╖┘Д╪и ╪з┘Д╪е╪╡┘Д╪з╪н: ${error.message}`);
                }
            }
        );
    };

    const emergencyRequests = useContext(AppContext).maintenanceRecords.filter(rec => rec.type === '╪╡┘К╪з┘Ж╪й ╪╖╪з╪▒╪ж╪й');

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">┘Ж┘Е┘И╪░╪м ╪╖┘Д╪и ╪е╪╡┘Д╪з╪н ╪╖╪з╪▒╪ж</h2>
            <form onSubmit={handleSubmit} className="space-y-4 mb-8">
                <SelectField
                    label="╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й"
                    name="carId"
                    value={formData.carId}
                    onChange={handleCarSelect}
                    options={cars.map(car => ({ value: car.id, label: car.carNumber }))}
                    required
                />
                <InputField label="╪з┘Д╪к╪з╪▒┘К╪о" name="date" type="date" value={formData.date} onChange={handleInputChange} required />
                <InputField label="┘И╪╡┘Б ╪з┘Д╪╣╪╖┘Д" name="description" value={formData.description} onChange={handleInputChange} type="textarea" required />
                <SelectField
                    label="╪з┘Д╪г┘И┘Д┘И┘К╪й"
                    name="priority"
                    value={formData.priority}
                    onChange={handleInputChange}
                    options={['╪╣╪з╪м┘Д', '┘Е╪к┘И╪│╪╖', '┘Е┘Ж╪о┘Б╪╢']}
                />
                <SelectField
                    label="╪з┘Д╪н╪з┘Д╪й"
                    name="status"
                    value={formData.status}
                    onChange={handleInputChange}
                    options={['┘В┘К╪п ╪з┘Д╪з┘Ж╪к╪╕╪з╪▒', '┘В┘К╪п ╪з┘Д╪е╪╡┘Д╪з╪н', '╪к┘Е ╪з┘Д╪е╪╡┘Д╪з╪н', '╪и╪з┘Ж╪к╪╕╪з╪▒ ┘В╪╖╪╣ ╪з┘Д╪║┘К╪з╪▒']}
                />
                <InputField label="╪з┘Д╪к┘Г┘Д┘Б╪й ╪з┘Д┘Е╪к┘И┘В╪╣╪й (╪▒┘К╪з┘Д)" name="estimatedCost" type="number" value={formData.estimatedCost} onChange={handleInputChange} />
                <InputField label="╪з┘Д╪к┘Г┘Д┘Б╪й ╪з┘Д┘Б╪╣┘Д┘К╪й (╪▒┘К╪з┘Д)" name="actualCost" type="number" value={formData.actualCost} onChange={handleInputChange} />
                <InputField label="╪з┘Д╪к┘И┘В┘К╪╣" name="signature" value={formData.signature} onChange={handleInputChange} required />

                <button
                    type="submit"
                    className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 shadow-md"
                >
                    {editingRequest ? '╪к╪н╪п┘К╪л ╪з┘Д╪╖┘Д╪и' : '╪е╪▒╪│╪з┘Д ╪╖┘Д╪и ╪з┘Д╪е╪╡┘Д╪з╪н'}
                </button>
                {editingRequest && (
                    <button
                        type="button"
                        onClick={() => {
                            setEditingRequest(null);
                            setFormData({
                                carId: '', carNumber: '', date: new Date().toISOString().split('T')[0],
                                description: '', priority: '┘Е╪к┘И╪│╪╖', status: '┘В┘К╪п ╪з┘Д╪з┘Ж╪к╪╕╪з╪▒',
                                estimatedCost: 0, actualCost: 0, signature: ''
                            });
                        }}
                        className="mr-2 px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors duration-200 shadow-md"
                    >
                        ╪е┘Д╪║╪з╪б ╪з┘Д╪к╪╣╪п┘К┘Д
                    </button>
                )}
            </form>

            <h3 className="text-lg font-semibold mb-4 text-gray-800">╪╖┘Д╪и╪з╪к ╪з┘Д╪е╪╡┘Д╪з╪н ╪з┘Д╪╖╪з╪▒╪ж╪й ╪з┘Д┘Е╪│╪м┘Д╪й</h3>
            {emergencyRequests.length === 0 ? (
                <p className="text-gray-600">┘Д╪з ╪к┘И╪м╪п ╪╖┘Д╪и╪з╪к ╪е╪╡┘Д╪з╪н ╪╖╪з╪▒╪ж╪й ┘Е╪│╪м┘Д╪й.</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead className="bg-gray-100">
                            <tr>
                                <th className="py-3 px-4 border-b text-right">╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д╪к╪з╪▒┘К╪о</th>
                                <th className="py-3 px-4 border-b text-right">┘И╪╡┘Б ╪з┘Д╪╣╪╖┘Д</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д╪г┘И┘Д┘И┘К╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д╪н╪з┘Д╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д╪к┘Г┘Д┘Б╪й ╪з┘Д┘Е╪к┘И┘В╪╣╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д╪к┘Г┘Д┘Б╪й ╪з┘Д┘Б╪╣┘Д┘К╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д╪е╪м╪▒╪з╪б╪з╪к</th>
                            </tr>
                        </thead>
                        <tbody>
                            {emergencyRequests.map(req => (
                                <tr key={req.id} className="hover:bg-gray-50 transition-colors duration-150">
                                    <td className="py-3 px-4 border-b">{req.carNumber}</td>
                                    <td className="py-3 px-4 border-b">{new Date(req.date).toLocaleDateString('ar-SA')}</td>
                                    <td className="py-3 px-4 border-b">{req.description}</td>
                                    <td className="py-3 px-4 border-b">{req.priority}</td>
                                    <td className="py-3 px-4 border-b">{req.status}</td>
                                    <td className="py-3 px-4 border-b">{req.estimatedCost} ╪▒┘К╪з┘Д</td>
                                    <td className="py-3 px-4 border-b">{req.actualCost} ╪▒┘К╪з┘Д</td>
                                    <td className="py-3 px-4 border-b">
                                        <button
                                            onClick={() => handleEditRequest(req)}
                                            className="ml-2 px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors duration-200 text-sm"
                                        >
                                            ╪к╪╣╪п┘К┘Д
                                        </button>
                                        <button
                                            onClick={() => handleDeleteRequest(req.id)}
                                            className="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 text-sm"
                                        >
                                            ╪н╪░┘Б
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};


// Monthly Maintenance Form Component
const MonthlyMaintenanceForm = () => {
    const { db, userId, cars, showMessage } = useContext(AppContext);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const [formData, setFormData] = useState({
        carId: '',
        carNumber: '',
        lastMaintenanceDate: new Date().toISOString().split('T')[0],
        maintenanceType: '', // '╪┤┘З╪▒┘К╪й', '╪▒╪и╪╣ ╪│┘Ж┘И┘К╪й', '╪│┘Ж┘И┘К╪й'
        mileage: 0,
        tasksCompleted: '', // Comma separated string or array
        nextMaintenanceDate: '',
        notes: '',
    });

    const [editingRecord, setEditingRecord] = useState(null);

    const handleCarSelect = (e) => {
        const selectedCarId = e.target.value;
        const car = cars.find(c => c.id === selectedCarId);
        setFormData(prev => ({
            ...prev,
            carId: selectedCarId,
            carNumber: car ? car.carNumber : '',
        }));
    };

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const calculateNextMaintenanceDate = (type, lastDate, mileage) => {
        const d = new Date(lastDate);
        switch (type) {
            case '╪┤┘З╪▒┘К╪й':
                d.setMonth(d.getMonth() + 1);
                return d.toISOString().split('T')[0];
            case '╪▒╪и╪╣ ╪│┘Ж┘И┘К╪й':
                d.setMonth(d.getMonth() + 3);
                return d.toISOString().split('T')[0];
            case '╪│┘Ж┘И┘К╪й':
                d.setFullYear(d.getFullYear() + 1);
                return d.toISOString().split('T')[0];
            default:
                return '';
        }
    };

    useEffect(() => {
        if (formData.lastMaintenanceDate && formData.maintenanceType) {
            const nextDate = calculateNextMaintenanceDate(formData.maintenanceType, formData.lastMaintenanceDate, formData.mileage);
            setFormData(prev => ({ ...prev, nextMaintenanceDate: nextDate }));
        }
    }, [formData.lastMaintenanceDate, formData.maintenanceType, formData.mileage]);


    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage('╪о╪╖╪г', '┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к ╪г┘И ┘Е╪╣╪▒┘Б ╪з┘Д┘Е╪│╪к╪о╪п┘Е ╪║┘К╪▒ ┘Е╪к╪з╪н.');
            return;
        }
        if (!formData.carId || !formData.lastMaintenanceDate || !formData.maintenanceType || !formData.mileage) {
            showMessage('╪о╪╖╪г', '╪з┘Д╪▒╪м╪з╪б ┘Е┘Д╪б ╪з┘Д╪н┘В┘И┘Д ╪з┘Д┘Е╪╖┘Д┘И╪и╪й (╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й╪М ╪к╪з╪▒┘К╪о ╪в╪о╪▒ ╪╡┘К╪з┘Ж╪й╪М ┘Ж┘И╪╣ ╪з┘Д╪╡┘К╪з┘Ж╪й╪М ╪з┘Д┘Е╪│╪з┘Б╪й ╪з┘Д┘Е┘В╪╖┘И╪╣╪й).');
            return;
        }

        try {
            const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
            if (editingRecord) {
                const docRef = doc(maintenanceCollectionRef, editingRecord.id);
                await updateDoc(docRef, { ...formData, timestamp: new Date() });
                showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪к╪н╪п┘К╪л ╪│╪м┘Д ╪з┘Д╪╡┘К╪з┘Ж╪й ╪з┘Д╪п┘И╪▒┘К╪й ╪и┘Ж╪м╪з╪н!');
                setEditingRecord(null);
            } else {
                await addDoc(maintenanceCollectionRef, {
                    ...formData,
                    type: formData.maintenanceType, // Use the selected type
                    timestamp: new Date(),
                });
                showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪к╪│╪м┘К┘Д ╪з┘Д╪╡┘К╪з┘Ж╪й ╪з┘Д╪п┘И╪▒┘К╪й ╪и┘Ж╪м╪з╪н!');
            }
            setFormData({
                carId: '', carNumber: '', lastMaintenanceDate: new Date().toISOString().split('T')[0],
                maintenanceType: '', mileage: 0, tasksCompleted: '', nextMaintenanceDate: '', notes: ''
            });
        } catch (error) {
            console.error("Error submitting monthly maintenance:", error);
            showMessage('╪о╪╖╪г', `┘Б╪┤┘Д ╪к╪│╪м┘К┘Д ╪з┘Д╪╡┘К╪з┘Ж╪й ╪з┘Д╪п┘И╪▒┘К╪й: ${error.message}`);
        }
    };

    const handleEditRecord = (record) => {
        setEditingRecord(record);
        setFormData(record);
    };

    const handleDeleteRecord = (recordId) => {
        showMessage(
            '╪к╪г┘Г┘К╪п ╪з┘Д╪н╪░┘Б',
            '┘З┘Д ╪г┘Ж╪к ┘Е╪к╪г┘Г╪п ╪г┘Ж┘Г ╪к╪▒┘К╪п ╪н╪░┘Б ╪│╪м┘Д ╪з┘Д╪╡┘К╪з┘Ж╪й ┘З╪░╪з╪Я',
            true,
            async () => {
                try {
                    const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
                    const docRef = doc(maintenanceCollectionRef, recordId);
                    await deleteDoc(docRef);
                    showMessage('┘Ж╪м╪з╪н', '╪к┘Е ╪н╪░┘Б ╪│╪м┘Д ╪з┘Д╪╡┘К╪з┘Ж╪й ╪и┘Ж╪м╪з╪н!');
                } catch (error) {
                    console.error("Error deleting maintenance record:", error);
                    showMessage('╪о╪╖╪г', `┘Б╪┤┘Д ╪н╪░┘Б ╪│╪м┘Д ╪з┘Д╪╡┘К╪з┘Ж╪й: ${error.message}`);
                }
            }
        );
    };

    const periodicMaintenanceRecords = useContext(AppContext).maintenanceRecords.filter(rec =>
        ['╪┤┘З╪▒┘К╪й', '╪▒╪и╪╣ ╪│┘Ж┘И┘К╪й', '╪│┘Ж┘И┘К╪й'].includes(rec.type)
    );

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">╪м╪п┘И┘Д ╪з┘Д╪╡┘К╪з┘Ж╪й ╪з┘Д╪п┘И╪▒┘К╪й</h2>
            <form onSubmit={handleSubmit} className="space-y-4 mb-8">
                <SelectField
                    label="╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й"
                    name="carId"
                    value={formData.carId}
                    onChange={handleCarSelect}
                    options={cars.map(car => ({ value: car.id, label: car.carNumber }))}
                    required
                />
                <InputField label="╪к╪з╪▒┘К╪о ╪в╪о╪▒ ╪╡┘К╪з┘Ж╪й" name="lastMaintenanceDate" type="date" value={formData.lastMaintenanceDate} onChange={handleInputChange} required />
                <SelectField
                    label="┘Ж┘И╪╣ ╪з┘Д╪╡┘К╪з┘Ж╪й"
                    name="maintenanceType"
                    value={formData.maintenanceType}
                    onChange={handleInputChange}
                    options={['╪┤┘З╪▒┘К╪й', '╪▒╪и╪╣ ╪│┘Ж┘И┘К╪й', '╪│┘Ж┘И┘К╪й']}
                    required
                />
                <InputField label="╪з┘Д┘Е╪│╪з┘Б╪й ╪з┘Д┘Е┘В╪╖┘И╪╣╪й (┘Г┘Е)" name="mileage" type="number" value={formData.mileage} onChange={handleInputChange} required />
                <InputField label="╪з┘Д┘Е┘З╪з┘Е ╪з┘Д┘Е┘Ж╪м╪▓╪й" name="tasksCompleted" value={formData.tasksCompleted} onChange={handleInputChange} type="textarea" placeholder="┘Е╪л╪з┘Д: ╪к╪║┘К┘К╪▒ ╪▓┘К╪к ┘Е╪н╪▒┘Г╪М ┘Б┘Д╪к╪▒ ┘З┘И╪з╪б" />
                <InputField label="╪з┘Д┘Е┘И╪╣╪п ╪з┘Д┘В╪з╪п┘Е" name="nextMaintenanceDate" type="date" value={formData.nextMaintenanceDate} onChange={handleInputChange} readOnly />
                <InputField label="┘Е┘Д╪з╪н╪╕╪з╪к" name="notes" value={formData.notes} onChange={handleInputChange} type="textarea" />

                <button
                    type="submit"
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md"
                >
                    {editingRecord ? '╪к╪н╪п┘К╪л ╪з┘Д╪│╪м┘Д' : '╪к╪│╪м┘К┘Д ╪з┘Д╪╡┘К╪з┘Ж╪й'}
                </button>
                {editingRecord && (
                    <button
                        type="button"
                        onClick={() => {
                            setEditingRecord(null);
                            setFormData({
                                carId: '', carNumber: '', lastMaintenanceDate: new Date().toISOString().split('T')[0],
                                maintenanceType: '', mileage: 0, tasksCompleted: '', nextMaintenanceDate: '', notes: ''
                            });
                        }}
                        className="mr-2 px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors duration-200 shadow-md"
                    >
                        ╪е┘Д╪║╪з╪б ╪з┘Д╪к╪╣╪п┘К┘Д
                    </button>
                )}
            </form>

            <h3 className="text-lg font-semibold mb-4 text-gray-800">╪│╪м┘Д╪з╪к ╪з┘Д╪╡┘К╪з┘Ж╪й ╪з┘Д╪п┘И╪▒┘К╪й</h3>
            {periodicMaintenanceRecords.length === 0 ? (
                <p className="text-gray-600">┘Д╪з ╪к┘И╪м╪п ╪│╪м┘Д╪з╪к ╪╡┘К╪з┘Ж╪й ╪п┘И╪▒┘К╪й ┘Е╪│╪м┘Д╪й.</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead className="bg-gray-100">
                            <tr>
                                <th className="py-3 px-4 border-b text-right">╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й</th>
                                <th className="py-3 px-4 border-b text-right">┘Ж┘И╪╣ ╪з┘Д╪╡┘К╪з┘Ж╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪к╪з╪▒┘К╪о ╪в╪о╪▒ ╪╡┘К╪з┘Ж╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д┘Е╪│╪з┘Б╪й (┘Г┘Е)</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д┘Е┘З╪з┘Е ╪з┘Д┘Е┘Ж╪м╪▓╪й</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д┘Е┘И╪╣╪п ╪з┘Д┘В╪з╪п┘Е</th>
                                <th className="py-3 px-4 border-b text-right">╪з┘Д╪е╪м╪▒╪з╪б╪з╪к</th>
                            </tr>
                        </thead>
                        <tbody>
                            {periodicMaintenanceRecords.map(rec => (
                                <tr key={rec.id} className="hover:bg-gray-50 transition-colors duration-150">
                                    <td className="py-3 px-4 border-b">{rec.carNumber}</td>
                                    <td className="py-3 px-4 border-b">{rec.maintenanceType}</td>
                                    <td className="py-3 px-4 border-b">{new Date(rec.lastMaintenanceDate).toLocaleDateString('ar-SA')}</td>
                                    <td className="py-3 px-4 border-b">{rec.mileage}</td>
                                    <td className="py-3 px-4 border-b">{rec.tasksCompleted}</td>
                                    <td className="py-3 px-4 border-b">{new Date(rec.nextMaintenanceDate).toLocaleDateString('ar-SA')}</td>
                                    <td className="py-3 px-4 border-b">
                                        <button
                                            onClick={() => handleEditRecord(rec)}
                                            className="ml-2 px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors duration-200 text-sm"
                                        >
                                            ╪к╪╣╪п┘К┘Д
                                        </button>
                                        <button
                                            onClick={() => handleDeleteRecord(rec.id)}
                                            className="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 text-sm"
                                        >
                                            ╪н╪░┘Б
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// Annual Report Component
const AnnualReport = () => {
    const { cars, maintenanceRecords, showMessage } = useContext(AppContext);
    const [selectedCarId, setSelectedCarId] = useState('');
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    const [reportData, setReportData] = useState(null);

    const generateReport = () => {
        if (!selectedCarId || !selectedYear) {
            showMessage('╪о╪╖╪г', '╪з┘Д╪▒╪м╪з╪б ╪з╪о╪к┘К╪з╪▒ ╪з┘Д╪│┘К╪з╪▒╪й ┘И╪з┘Д╪│┘Ж╪й ┘Д╪е┘Ж╪┤╪з╪б ╪з┘Д╪к┘В╪▒┘К╪▒.');
            return;
        }

        const car = cars.find(c => c.id === selectedCarId);
        if (!car) {
            showMessage('╪о╪╖╪г', '╪з┘Д╪│┘К╪з╪▒╪й ╪з┘Д┘Е╪о╪к╪з╪▒╪й ╪║┘К╪▒ ┘Е┘И╪м┘И╪п╪й.');
            return;
        }

        const yearRecords = maintenanceRecords.filter(record => {
            const recordDate = new Date(record.date || record.lastMaintenanceDate || record.timestamp.toDate());
            return record.carId === selectedCarId && recordDate.getFullYear() === selectedYear;
        });

        let totalAnnualMileage = 0;
        let totalCost = 0;
        const maintenanceCount = {
            '╪╡┘К╪з┘Ж╪й ┘К┘И┘Е┘К╪й': 0,
            '╪╡┘К╪з┘Ж╪й ╪г╪│╪и┘И╪╣┘К╪й': 0,
            '╪┤┘З╪▒┘К╪й': 0,
            '╪▒╪и╪╣ ╪│┘Ж┘И┘К╪й': 0,
            '╪│┘Ж┘И┘К╪й': 0,
            '╪╡┘К╪з┘Ж╪й ╪╖╪з╪▒╪ж╪й': 0,
        };
        const recurringFaults = {}; // { description: count }

        yearRecords.forEach(record => {
            if (record.mileage) {
                totalAnnualMileage += parseInt(record.mileage, 10);
            }
            if (record.actualCost) {
                totalCost += parseFloat(record.actualCost);
            } else if (record.estimatedCost && record.status === '╪к┘Е ╪з┘Д╪е╪╡┘Д╪з╪н') {
                totalCost += parseFloat(record.estimatedCost);
            }

            if (maintenanceCount[record.type]) {
                maintenanceCount[record.type]++;
            } else {
                maintenanceCount[record.type] = 1;
            }

            if (record.type === '╪╡┘К╪з┘Ж╪й ╪╖╪з╪▒╪ж╪й' && record.description) {
                recurringFaults[record.description] = (recurringFaults[record.description] || 0) + 1;
            }
        });

        const sortedRecurringFaults = Object.entries(recurringFaults)
            .filter(([, count]) => count > 1) // Only show faults that occurred more than once
            .sort((a, b) => b[1] - a[1])
            .map(([desc, count]) => `${desc} (${count} ┘Е╪▒╪з╪к)`);

        setReportData({
            carNumber: car.carNumber,
            annualMileage: totalAnnualMileage,
            totalMaintenanceCount: yearRecords.length,
            maintenanceBreakdown: maintenanceCount,
            totalCosts: totalCost,
            recurringFaults: sortedRecurringFaults.length > 0 ? sortedRecurringFaults.join(', ') : '┘Д╪з ╪к┘И╪м╪п ╪г╪╣╪╖╪з┘Д ┘Е╪к┘Г╪▒╪▒╪й',
            carConditionRating: '╪м┘К╪п╪й (тнРя╕ПтнРя╕ПтнРя╕ПтнРя╕П)' // This would ideally be a manual input or calculated based on severity of faults
        });
    };

    const handlePrint = () => {
        const printContent = document.getElementById('annual-report-content').innerHTML;
        const originalContent = document.body.innerHTML;
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
        window.location.reload(); // Reload to restore original page
    };

    const handleShare = () => {
        // In a real application, this would generate a unique, read-only link to the report.
        // For this example, we'll just provide the current URL as a placeholder.
        const reportUrl = window.location.href; // This is the app URL, not a specific report URL
        navigator.clipboard.writeText(reportUrl)
            .then(() => showMessage('┘Ж╪м╪з╪н', '╪к┘Е ┘Ж╪│╪о ╪▒╪з╪и╪╖ ╪з┘Д╪к╪╖╪и┘К┘В ╪е┘Д┘Й ╪з┘Д╪н╪з┘Б╪╕╪й. ┘К┘Е┘Г┘Ж┘Г ┘Е╪┤╪з╪▒┘Г╪к┘З ┘Е╪╣ ╪з┘Д╪в╪о╪▒┘К┘Ж ┘Д╪╣╪▒╪╢ ╪з┘Д╪к┘В╪з╪▒┘К╪▒ (╪е╪░╪з ┘Г╪з┘Ж ┘Д╪п┘К┘З┘Е ╪╡┘Д╪з╪н┘К╪й ╪з┘Д┘И╪╡┘И┘Д).'))
            .catch(() => showMessage('╪о╪╖╪г', '┘Б╪┤┘Д ┘Ж╪│╪о ╪з┘Д╪▒╪з╪и╪╖ ╪е┘Д┘Й ╪з┘Д╪н╪з┘Б╪╕╪й. ┘К╪▒╪м┘Й ╪з┘Д┘Ж╪│╪о ┘К╪п┘И┘К┘Л╪з.'));
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">╪к┘В╪▒┘К╪▒ ╪╡┘К╪з┘Ж╪й ╪│┘Ж┘И┘К</h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <SelectField
                    label="╪з╪о╪к╪▒ ╪з┘Д╪│┘К╪з╪▒╪й"
                    name="selectedCarId"
                    value={selectedCarId}
                    onChange={(e) => setSelectedCarId(e.target.value)}
                    options={cars.map(car => ({ value: car.id, label: car.carNumber }))}
                    required
                />
                <SelectField
                    label="╪з╪о╪к╪▒ ╪з┘Д╪│┘Ж╪й"
                    name="selectedYear"
                    value={selectedYear}
                    onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                    options={Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - i)} // Last 5 years
                    required
                />
            </div>

            <button
                onClick={generateReport}
                className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 shadow-md mb-6"
            >
                ╪е┘Ж╪┤╪з╪б ╪з┘Д╪к┘В╪▒┘К╪▒
            </button>

            {reportData && (
                <div id="annual-report-content" className="border border-gray-200 p-6 rounded-lg bg-gray-50 mt-8">
                    <h3 className="text-xl font-bold mb-4 text-gray-800">╪к┘В╪▒┘К╪▒ ╪з┘Д╪╡┘К╪з┘Ж╪й ╪з┘Д╪│┘Ж┘И┘К ┘Д┘А {reportData.carNumber} - ╪│┘Ж╪й {selectedYear}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                        <p><strong>╪▒┘В┘Е ╪з┘Д╪│┘К╪з╪▒╪й:</strong> {reportData.carNumber}</p>
                        <p><strong>╪з┘Д┘Е╪│╪з┘Б╪й ╪з┘Д╪│┘Ж┘И┘К╪й:</strong> {reportData.annualMileage} ┘Г┘Е</p>
                        <p><strong>╪╣╪п╪п ┘Е╪▒╪з╪к ╪з┘Д╪╡┘К╪з┘Ж╪й:</strong> {reportData.totalMaintenanceCount}</p>
                        <p><strong>╪з┘Д╪к┘Г╪з┘Д┘К┘Б ╪з┘Д╪е╪м┘Е╪з┘Д┘К╪й:</strong> {reportData.totalCosts} ╪▒┘К╪з┘Д</p>
                        <p><strong>╪з┘Д╪г╪╣╪╖╪з┘Д ╪з┘Д┘Е╪к┘Г╪▒╪▒╪й:</strong> {reportData.recurringFaults}</p>
                        <p><strong>╪к┘В┘К┘К┘Е ╪н╪з┘Д╪й ╪з┘Д╪│┘К╪з╪▒╪й:</strong> {reportData.carConditionRating}</p>
                    </div>
                    <div className="mt-6">
                        <h4 className="text-lg font-semibold mb-2">╪к┘Б╪╡┘К┘Д ╪г┘Ж┘И╪з╪╣ ╪з┘Д╪╡┘К╪з┘Ж╪й:</h4>
                        <ul className="list-disc list-inside text-gray-700">
                            {Object.entries(reportData.maintenanceBreakdown).map(([type, count]) => (
                                <li key={type}>{type}: {count} ┘Е╪▒╪з╪к</li>
                            ))}
                        </ul>
                    </div>
                    <div className="flex justify-end space-x-2 mt-6">
                        <button
                            onClick={handlePrint}
                            className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200"
                        >
                            ╪╖╪и╪з╪╣╪й ╪з┘Д╪к┘В╪▒┘К╪▒
                        </button>
                        <button
                            onClick={handleShare}
                            className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors duration-200"
                        >
                            ┘Е╪┤╪з╪▒┘Г╪й ╪з┘Д╪▒╪з╪и╪╖
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};


export default App;
я┐╜