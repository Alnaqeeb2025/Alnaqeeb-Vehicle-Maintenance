import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, deleteDoc, query, where } from 'firebase/firestore';

// Context for Firebase and User data
const AppContext = createContext();

// Custom Modal Component (replaces alert/confirm)
const CustomModal = ({ isOpen, title, message, onClose, onConfirm, showConfirmButton = false }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-right" dir="rtl">
                <h3 className="text-lg font-semibold mb-4 text-gray-800">{title}</h3>
                <p className="text-gray-700 mb-6">{message}</p>
                <div className="flex justify-end space-x-2">
                    <button
                        onClick={onClose}
                        className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors duration-200"
                    >
                        ุฅุบูุงู
                    </button>
                    {showConfirmButton && (
                        <button
                            onClick={onConfirm}
                            className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200"
                        >
                            ุชุฃููุฏ
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};

// Main App Component
function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard', 'cars', 'dailyCheck', 'emergency', 'monthly', 'annualReport'
    const [cars, setCars] = useState([]);
    const [maintenanceRecords, setMaintenanceRecords] = useState([]);
    const [selectedCar, setSelectedCar] = useState(null);

    // Modal state
    const [modal, setModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        onClose: () => setModal({ ...modal, isOpen: false }),
        onConfirm: null,
        showConfirmButton: false,
    });

    // Initialize Firebase
    useEffect(() => {
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Please provide it via __firebase_config.");
                setModal({
                    isOpen: true,
                    title: 'ุฎุทุฃ ูู ุงูุชููุฆุฉ',
                    message: 'ูู ูุชู ุชูููุฑ ุฅุนุฏุงุฏุงุช Firebase ุจุดูู ุตุญูุญ. ูุฑุฌู ุงูุชุญูู ูู ุงูุชูููู.',
                });
                return;
            }

            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);

            setDb(firestore);
            setAuth(authInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    // Sign in anonymously if no user is authenticated and no custom token is available
                    if (typeof __initial_auth_token === 'undefined' || !__initial_auth_token) {
                        await signInAnonymously(authInstance);
                    }
                }
                setIsAuthReady(true);
            });

            // Attempt to sign in with custom token if available
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (authInstance && initialAuthToken) {
                signInWithCustomToken(authInstance, initialAuthToken)
                    .then(() => console.log("Signed in with custom token"))
                    .catch((error) => {
                        console.error("Error signing in with custom token:", error);
                        // Fallback to anonymous if custom token fails
                        signInAnonymously(authInstance)
                            .then(() => console.log("Signed in anonymously after custom token failure"))
                            .catch(anonError => console.error("Error signing in anonymously:", anonError));
                    });
            } else if (authInstance) {
                // If no custom token, sign in anonymously
                signInAnonymously(authInstance)
                    .then(() => console.log("Signed in anonymously"))
                    .catch(anonError => console.error("Error signing in anonymously:", anonError));
            }

            return () => unsubscribe();
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
            setModal({
                isOpen: true,
                title: 'ุฎุทุฃ ูุงุฏุญ',
                message: `ูุดู ุชููุฆุฉ Firebase: ${error.message}. ูุฑุฌู ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุชู.`,
            });
        }
    }, []);

    // Fetch Cars and Maintenance Records
    useEffect(() => {
        if (!db || !isAuthReady || !userId) return;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Listen for cars collection (public data)
        const carsRef = collection(db, `artifacts/${appId}/public/data/cars`);
        const unsubscribeCars = onSnapshot(carsRef, (snapshot) => {
            const carsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setCars(carsData);
        }, (error) => {
            console.error("Error fetching cars:", error);
            setModal({
                isOpen: true,
                title: 'ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช',
                message: `ูุดู ุฌูุจ ุจูุงูุงุช ุงูุณูุงุฑุงุช: ${error.message}`,
            });
        });

        // Listen for maintenance records (private data)
        const maintenanceRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
        const unsubscribeMaintenance = onSnapshot(maintenanceRef, (snapshot) => {
            const recordsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMaintenanceRecords(recordsData);
        }, (error) => {
            console.error("Error fetching maintenance records:", error);
            setModal({
                isOpen: true,
                title: 'ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช',
                message: `ูุดู ุฌูุจ ุณุฌูุงุช ุงูุตูุงูุฉ: ${error.message}`,
            });
        });

        return () => {
            unsubscribeCars();
            unsubscribeMaintenance();
        };
    }, [db, isAuthReady, userId]);

    const showMessage = (title, message, showConfirm = false, onConfirm = null) => {
        setModal({
            isOpen: true,
            title,
            message,
            onClose: () => setModal({ ...modal, isOpen: false }),
            onConfirm,
            showConfirmButton: showConfirm,
        });
    };

    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-center p-6 bg-white rounded-lg shadow-md">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"></div>
                    <p className="text-gray-700">ุฌุงุฑู ุชุญููู ุงูุชุทุจูู...</p>
                </div>
            </div>
        );
    }

    return (
        <AppContext.Provider value={{ db, auth, userId, cars, maintenanceRecords, setCars, setMaintenanceRecords, showMessage, selectedCar, setSelectedCar }}>
            <div className="min-h-screen bg-gray-100 font-sans text-gray-900" dir="rtl">
                <CustomModal {...modal} />

                <nav className="bg-gradient-to-r from-blue-600 to-blue-800 p-4 shadow-lg">
                    <div className="container mx-auto flex flex-wrap justify-between items-center">
                        <h1 className="text-white text-2xl font-bold rounded-md px-3 py-1">ูุธุงู ุฅุฏุงุฑุฉ ุตูุงูุฉ ุงูุณูุงุฑุงุช</h1>
                        <div className="flex space-x-4 space-x-reverse mt-2 md:mt-0">
                            <NavItem onClick={() => setCurrentView('dashboard')} isActive={currentView === 'dashboard'}>ุงูุฑุฆูุณูุฉ</NavItem>
                            <NavItem onClick={() => setCurrentView('cars')} isActive={currentView === 'cars'}>ุงูุณูุงุฑุงุช</NavItem>
                            <NavItem onClick={() => setCurrentView('dailyCheck')} isActive={currentView === 'dailyCheck'}>ูุญุต ูููู</NavItem>
                            <NavItem onClick={() => setCurrentView('emergency')} isActive={currentView === 'emergency'}>ุทูุจ ุฅุตูุงุญ ุทุงุฑุฆ</NavItem>
                            <NavItem onClick={() => setCurrentView('monthly')} isActive={currentView === 'monthly'}>ุตูุงูุฉ ุฏูุฑูุฉ</NavItem>
                            <NavItem onClick={() => setCurrentView('annualReport')} isActive={currentView === 'annualReport'}>ุชูุงุฑูุฑ ุณูููุฉ</NavItem>
                        </div>
                        <div className="text-white text-sm mt-2 md:mt-0">
                            ูุนุฑู ุงููุณุชุฎุฏู: {userId}
                        </div>
                    </div>
                </nav>

                <main className="container mx-auto p-6">
                    {currentView === 'dashboard' && <Dashboard />}
                    {currentView === 'cars' && <CarManagement />}
                    {currentView === 'dailyCheck' && <DailyCheckForm />}
                    {currentView === 'emergency' && <EmergencyRequestForm />}
                    {currentView === 'monthly' && <MonthlyMaintenanceForm />}
                    {currentView === 'annualReport' && <AnnualReport />}
                </main>
            </div>
        </AppContext.Provider>
    );
}

// Navigation Item Component
const NavItem = ({ children, onClick, isActive }) => (
    <button
        onClick={onClick}
        className={`px-4 py-2 rounded-md transition-all duration-300 ${isActive ? 'bg-blue-500 text-white shadow-md' : 'text-blue-100 hover:bg-blue-700 hover:text-white'}`}
    >
        {children}
    </button>
);

// Dashboard Component
const Dashboard = () => {
    const { cars, maintenanceRecords } = useContext(AppContext);

    // Calculate upcoming maintenance (example: next 30 days for monthly/quarterly/annual)
    const upcomingMaintenance = maintenanceRecords.filter(record => {
        const nextDate = record.nextMaintenanceDate ? new Date(record.nextMaintenanceDate) : null;
        if (!nextDate) return false;
        const today = new Date();
        const thirtyDaysLater = new Date();
        thirtyDaysLater.setDate(today.getDate() + 30);
        return nextDate >= today && nextDate <= thirtyDaysLater;
    }).sort((a, b) => new Date(a.nextMaintenanceDate) - new Date(b.nextMaintenanceDate));

    // Calculate open emergency requests
    const openEmergencyRequests = maintenanceRecords.filter(record =>
        record.type === 'emergency' && record.status !== 'ุชู ุงูุฅุตูุงุญ'
    );

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <DashboardCard title="ุฅุฌูุงูู ุงูุณูุงุฑุงุช" value={cars.length} icon="๐" />
            <DashboardCard title="ุตูุงูุฉ ูุงุฏูุฉ (30 ููููุง)" value={upcomingMaintenance.length} icon="๐๏ธ" />
            <DashboardCard title="ุทูุจุงุช ุฅุตูุงุญ ููุชูุญุฉ" value={openEmergencyRequests.length} icon="โ๏ธ" />

            <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-xl font-semibold mb-4 text-gray-800">ุงูุตูุงูุฉ ุงููุงุฏูุฉ</h2>
                {upcomingMaintenance.length > 0 ? (
                    <ul className="space-y-3">
                        {upcomingMaintenance.map(record => (
                            <li key={record.id} className="p-3 bg-blue-50 rounded-md border border-blue-200 flex justify-between items-center text-sm">
                                <div>
                                    <p className="font-medium">ุงูุณูุงุฑุฉ: {record.carNumber}</p>
                                    <p>ุงูููุน: {record.type}</p>
                                    <p>ุงูููุนุฏ: {new Date(record.nextMaintenanceDate).toLocaleDateString('ar-SA')}</p>
                                </div>
                                <span className="text-blue-600 font-bold">ูุฑูุจูุง</span>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <p className="text-gray-600">ูุง ุชูุฌุฏ ุตูุงูุฉ ูุงุฏูุฉ ุฎูุงู 30 ููููุง.</p>
                )}
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-xl font-semibold mb-4 text-gray-800">ุทูุจุงุช ุงูุฅุตูุงุญ ุงูููุชูุญุฉ</h2>
                {openEmergencyRequests.length > 0 ? (
                    <ul className="space-y-3">
                        {openEmergencyRequests.map(record => (
                            <li key={record.id} className="p-3 bg-yellow-50 rounded-md border border-yellow-200 text-sm">
                                <p className="font-medium">ุงูุณูุงุฑุฉ: {record.carNumber}</p>
                                <p>ุงูุนุทู: {record.description}</p>
                                <p>ุงูุญุงูุฉ: <span className="font-semibold text-yellow-700">{record.status}</span></p>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <p className="text-gray-600">ูุง ุชูุฌุฏ ุทูุจุงุช ุฅุตูุงุญ ููุชูุญุฉ ุญุงูููุง.</p>
                )}
            </div>
        </div>
    );
};

// Dashboard Card Component
const DashboardCard = ({ title, value, icon }) => (
    <div className="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
        <div>
            <h3 className="text-lg font-semibold text-gray-700">{title}</h3>
            <p className="text-3xl font-bold text-blue-600">{value}</p>
        </div>
        <span className="text-5xl">{icon}</span>
    </div>
);

// Car Management Component
const CarManagement = () => {
    const { cars, showMessage, db, setCars } = useContext(AppContext);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const [isAddingCar, setIsAddingCar] = useState(false);
    const [newCarData, setNewCarData] = useState({
        carNumber: '', model: '', year: '', fuelType: '', plateNumber: '', owner: '', currentMileage: 0
    });
    const [editingCar, setEditingCar] = useState(null); // State to hold car being edited

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setNewCarData(prev => ({ ...prev, [name]: value }));
    };

    const handleAddCar = async (e) => {
        e.preventDefault();
        if (!db) {
            showMessage('ุฎุทุฃ', 'ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูููุฃุฉ.');
            return;
        }

        if (!newCarData.carNumber || !newCarData.model || !newCarData.plateNumber) {
            showMessage('ุฎุทุฃ', 'ุงูุฑุฌุงุก ููุก ุงูุญููู ุงููุทููุจุฉ (ุฑูู ุงูุณูุงุฑุฉุ ุงูููุฏููุ ุฑูู ุงูููุญุฉ).');
            return;
        }

        try {
            const carsCollectionRef = collection(db, `artifacts/${appId}/public/data/cars`);
            await addDoc(carsCollectionRef, newCarData);
            showMessage('ูุฌุงุญ', 'ุชูุช ุฅุถุงูุฉ ุงูุณูุงุฑุฉ ุจูุฌุงุญ!');
            setNewCarData({ carNumber: '', model: '', year: '', fuelType: '', plateNumber: '', owner: '', currentMileage: 0 });
            setIsAddingCar(false);
        } catch (error) {
            console.error("Error adding car:", error);
            showMessage('ุฎุทุฃ', `ูุดู ุฅุถุงูุฉ ุงูุณูุงุฑุฉ: ${error.message}`);
        }
    };

    const handleEditCar = (car) => {
        setEditingCar(car);
        setNewCarData(car); // Populate form with existing car data
        setIsAddingCar(true); // Show the form for editing
    };

    const handleUpdateCar = async (e) => {
        e.preventDefault();
        if (!db || !editingCar) {
            showMessage('ุฎุทุฃ', 'ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูููุฃุฉ ุฃู ูุง ุชูุฌุฏ ุณูุงุฑุฉ ููุชุญุฏูุซ.');
            return;
        }

        try {
            const carDocRef = doc(db, `artifacts/${appId}/public/data/cars`, editingCar.id);
            await updateDoc(carDocRef, newCarData);
            showMessage('ูุฌุงุญ', 'ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุณูุงุฑุฉ ุจูุฌุงุญ!');
            setEditingCar(null);
            setNewCarData({ carNumber: '', model: '', year: '', fuelType: '', plateNumber: '', owner: '', currentMileage: 0 });
            setIsAddingCar(false);
        } catch (error) {
            console.error("Error updating car:", error);
            showMessage('ุฎุทุฃ', `ูุดู ุชุญุฏูุซ ุงูุณูุงุฑุฉ: ${error.message}`);
        }
    };

    const handleDeleteCar = (carId) => {
        showMessage(
            'ุชุฃููุฏ ุงูุญุฐู',
            'ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ูุฐู ุงูุณูุงุฑุฉุ ุณูุชู ุญุฐู ุฌููุน ุณุฌูุงุช ุงูุตูุงูุฉ ุงููุชุนููุฉ ุจูุง ุฃูุถูุง.',
            true,
            async () => {
                try {
                    // Delete car document
                    const carDocRef = doc(db, `artifacts/${appId}/public/data/cars`, carId);
                    await deleteDoc(carDocRef);

                    // Optional: Delete related maintenance records (more complex query needed for private data)
                    // For simplicity, this example only deletes the car.
                    // In a real app, you'd query and delete all maintenance records linked to this carId.

                    showMessage('ูุฌุงุญ', 'ุชู ุญุฐู ุงูุณูุงุฑุฉ ุจูุฌุงุญ!');
                    setCars(prev => prev.filter(car => car.id !== carId)); // Update local state
                } catch (error) {
                    console.error("Error deleting car:", error);
                    showMessage('ุฎุทุฃ', `ูุดู ุญุฐู ุงูุณูุงุฑุฉ: ${error.message}`);
                }
            }
        );
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">ุฅุฏุงุฑุฉ ุงูุณูุงุฑุงุช</h2>

            <button
                onClick={() => { setIsAddingCar(!isAddingCar); setEditingCar(null); setNewCarData({ carNumber: '', model: '', year: '', fuelType: '', plateNumber: '', owner: '', currentMileage: 0 }); }}
                className="mb-6 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md"
            >
                {isAddingCar ? 'ุฅูุบุงุก ุฅุถุงูุฉ/ุชุนุฏูู ุณูุงุฑุฉ' : 'ุฅุถุงูุฉ ุณูุงุฑุฉ ุฌุฏูุฏุฉ'}
            </button>

            {isAddingCar && (
                <form onSubmit={editingCar ? handleUpdateCar : handleAddCar} className="mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                    <h3 className="text-lg font-semibold mb-4 text-gray-800">{editingCar ? 'ุชุนุฏูู ุจูุงูุงุช ุงูุณูุงุฑุฉ' : 'ุฅุถุงูุฉ ุณูุงุฑุฉ ุฌุฏูุฏุฉ'}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <InputField label="ุฑูู ุงูุณูุงุฑุฉ" name="carNumber" value={newCarData.carNumber} onChange={handleInputChange} required />
                        <InputField label="ุงูููุฏูู" name="model" value={newCarData.model} onChange={handleInputChange} required />
                        <InputField label="ุณูุฉ ุงูุตูุน" name="year" type="number" value={newCarData.year} onChange={handleInputChange} />
                        <InputField label="ููุน ุงููููุฏ" name="fuelType" value={newCarData.fuelType} onChange={handleInputChange} />
                        <InputField label="ุฑูู ุงูููุญุฉ" name="plateNumber" value={newCarData.plateNumber} onChange={handleInputChange} required />
                        <InputField label="ุงููุงูู/ุงููุณุชุฎุฏู ุงูุฃุณุงุณู" name="owner" value={newCarData.owner} onChange={handleInputChange} />
                        <InputField label="ุนุฏุงุฏ ุงููุณุงูุงุช ุงูุญุงูู (ูู)" name="currentMileage" type="number" value={newCarData.currentMileage} onChange={handleInputChange} />
                    </div>
                    <button
                        type="submit"
                        className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 shadow-md"
                    >
                        {editingCar ? 'ุชุญุฏูุซ ุงูุณูุงุฑุฉ' : 'ุฅุถุงูุฉ ุงูุณูุงุฑุฉ'}
                    </button>
                </form>
            )}

            <h3 className="text-lg font-semibold mb-4 text-gray-800">ูุงุฆูุฉ ุงูุณูุงุฑุงุช ุงููุณุฌูุฉ</h3>
            {cars.length === 0 ? (
                <p className="text-gray-600">ูุง ุชูุฌุฏ ุณูุงุฑุงุช ูุณุฌูุฉ ุจุนุฏ. ุงุจุฏุฃ ุจุฅุถุงูุฉ ุณูุงุฑุฉ ุฌุฏูุฏุฉ!</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead className="bg-gray-100">
                            <tr>
                                <th className="py-3 px-4 border-b text-right">ุฑูู ุงูุณูุงุฑุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุงูููุฏูู</th>
                                <th className="py-3 px-4 border-b text-right">ุฑูู ุงูููุญุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุนุฏุงุฏ ุงููุณุงูุงุช</th>
                                <th className="py-3 px-4 border-b text-right">ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            {cars.map(car => (
                                <tr key={car.id} className="hover:bg-gray-50 transition-colors duration-150">
                                    <td className="py-3 px-4 border-b">{car.carNumber}</td>
                                    <td className="py-3 px-4 border-b">{car.model}</td>
                                    <td className="py-3 px-4 border-b">{car.plateNumber}</td>
                                    <td className="py-3 px-4 border-b">{car.currentMileage || 'ุบูุฑ ูุญุฏุฏ'} ูู</td>
                                    <td className="py-3 px-4 border-b">
                                        <button
                                            onClick={() => handleEditCar(car)}
                                            className="ml-2 px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors duration-200 text-sm"
                                        >
                                            ุชุนุฏูู
                                        </button>
                                        <button
                                            onClick={() => handleDeleteCar(car.id)}
                                            className="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 text-sm"
                                        >
                                            ุญุฐู
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// Form Input Field Component
const InputField = ({ label, name, value, onChange, type = 'text', required = false }) => (
    <div>
        <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">
            {label} {required && <span className="text-red-500">*</span>}
        </label>
        <input
            type={type}
            id={name}
            name={name}
            value={value}
            onChange={onChange}
            required={required}
            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
        />
    </div>
);

// Form Select Field Component
const SelectField = ({ label, name, value, onChange, options, required = false }) => (
    <div>
        <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">
            {label} {required && <span className="text-red-500">*</span>}
        </label>
        <select
            id={name}
            name={name}
            value={value}
            onChange={onChange}
            required={required}
            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white"
        >
            <option value="">ุงุฎุชุฑ...</option>
            {options.map((option, index) => (
                <option key={index} value={option.value || option}>{option.label || option}</option>
            ))}
        </select>
    </div>
);

// Daily Check Form Component
const DailyCheckForm = () => {
    const { db, userId, cars, showMessage } = useContext(AppContext);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const [formData, setFormData] = useState({
        carId: '',
        carNumber: '', // To store car number for easier display/query
        date: new Date().toISOString().split('T')[0],
        oilCheck: false,
        tirePressure: '',
        lightsCheck: false,
        brakesCheck: false,
        coolingFluidsCheck: false,
        cleanlinessCheck: false,
        notes: '',
        driverSignature: '',
    });

    const handleCarSelect = (e) => {
        const selectedCarId = e.target.value;
        const car = cars.find(c => c.id === selectedCarId);
        setFormData(prev => ({
            ...prev,
            carId: selectedCarId,
            carNumber: car ? car.carNumber : '',
        }));
    };

    const handleInputChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: type === 'checkbox' ? checked : value,
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage('ุฎุทุฃ', 'ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ูุนุฑู ุงููุณุชุฎุฏู ุบูุฑ ูุชุงุญ.');
            return;
        }
        if (!formData.carId || !formData.date || !formData.driverSignature) {
            showMessage('ุฎุทุฃ', 'ุงูุฑุฌุงุก ููุก ุงูุญููู ุงููุทููุจุฉ (ุฑูู ุงูุณูุงุฑุฉุ ุงูุชุงุฑูุฎุ ุชูููุน ุงูุณุงุฆู).');
            return;
        }

        try {
            const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
            await addDoc(maintenanceCollectionRef, {
                ...formData,
                type: 'ุตูุงูุฉ ููููุฉ',
                timestamp: new Date(),
            });
            showMessage('ูุฌุงุญ', 'ุชู ุชุณุฌูู ุงููุญุต ุงููููู ุจูุฌุงุญ!');
            setFormData({
                carId: '',
                carNumber: '',
                date: new Date().toISOString().split('T')[0],
                oilCheck: false,
                tirePressure: '',
                lightsCheck: false,
                brakesCheck: false,
                coolingFluidsCheck: false,
                cleanlinessCheck: false,
                notes: '',
                driverSignature: '',
            });
        } catch (error) {
            console.error("Error adding daily check:", error);
            showMessage('ุฎุทุฃ', `ูุดู ุชุณุฌูู ุงููุญุต ุงููููู: ${error.message}`);
        }
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">ูููุฐุฌ ุงููุญุต ุงููููู ููุณูุงุฑุฉ</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
                <SelectField
                    label="ุฑูู ุงูุณูุงุฑุฉ"
                    name="carId"
                    value={formData.carId}
                    onChange={handleCarSelect}
                    options={cars.map(car => ({ value: car.id, label: car.carNumber }))}
                    required
                />
                <InputField label="ุงูุชุงุฑูุฎ" name="date" type="date" value={formData.date} onChange={handleInputChange} required />

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <CheckboxField label="ูุญุต ุงูุฒูุช" name="oilCheck" checked={formData.oilCheck} onChange={handleInputChange} />
                    <InputField label="ุถุบุท ุงูุฅุทุงุฑุงุช" name="tirePressure" value={formData.tirePressure} onChange={handleInputChange} placeholder="ูุซุงู: 32 PSI" />
                    <CheckboxField label="ูุญุต ุงูุฅุถุงุกุฉ" name="lightsCheck" checked={formData.lightsCheck} onChange={handleInputChange} />
                    <CheckboxField label="ูุญุต ุงููุฑุงูู" name="brakesCheck" checked={formData.brakesCheck} onChange={handleInputChange} />
                    <CheckboxField label="ูุญุต ุณูุงุฆู ุงูุชุจุฑูุฏ" name="coolingFluidsCheck" checked={formData.coolingFluidsCheck} onChange={handleInputChange} />
                    <CheckboxField label="ูุธุงูุฉ ุงูุณูุงุฑุฉ" name="cleanlinessCheck" checked={formData.cleanlinessCheck} onChange={handleInputChange} />
                </div>

                <InputField label="ููุงุญุธุงุช" name="notes" value={formData.notes} onChange={handleInputChange} type="textarea" />
                <InputField label="ุชูููุน ุงูุณุงุฆู" name="driverSignature" value={formData.driverSignature} onChange={handleInputChange} required />

                <button
                    type="submit"
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md"
                >
                    ุชุณุฌูู ุงููุญุต
                </button>
            </form>
        </div>
    );
};

// Checkbox Field Component
const CheckboxField = ({ label, name, checked, onChange }) => (
    <div className="flex items-center">
        <input
            type="checkbox"
            id={name}
            name={name}
            checked={checked}
            onChange={onChange}
            className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
        />
        <label htmlFor={name} className="mr-2 text-sm font-medium text-gray-700">
            {label}
        </label>
    </div>
);


// Emergency Request Form Component
const EmergencyRequestForm = () => {
    const { db, userId, cars, showMessage } = useContext(AppContext);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const [formData, setFormData] = useState({
        carId: '',
        carNumber: '',
        date: new Date().toISOString().split('T')[0],
        description: '',
        priority: 'ูุชูุณุท', // 'ุนุงุฌู', 'ูุชูุณุท', 'ููุฎูุถ'
        status: 'ููุฏ ุงูุงูุชุธุงุฑ', // 'ููุฏ ุงูุงูุชุธุงุฑ', 'ููุฏ ุงูุฅุตูุงุญ', 'ุชู ุงูุฅุตูุงุญ', 'ุจุงูุชุธุงุฑ ูุทุน ุงูุบูุงุฑ'
        estimatedCost: 0,
        actualCost: 0,
        signature: '',
    });

    const [editingRequest, setEditingRequest] = useState(null);

    const handleCarSelect = (e) => {
        const selectedCarId = e.target.value;
        const car = cars.find(c => c.id === selectedCarId);
        setFormData(prev => ({
            ...prev,
            carId: selectedCarId,
            carNumber: car ? car.carNumber : '',
        }));
    };

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage('ุฎุทุฃ', 'ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ูุนุฑู ุงููุณุชุฎุฏู ุบูุฑ ูุชุงุญ.');
            return;
        }
        if (!formData.carId || !formData.description || !formData.signature) {
            showMessage('ุฎุทุฃ', 'ุงูุฑุฌุงุก ููุก ุงูุญููู ุงููุทููุจุฉ (ุฑูู ุงูุณูุงุฑุฉุ ูุตู ุงูุนุทูุ ุงูุชูููุน).');
            return;
        }

        try {
            const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
            if (editingRequest) {
                const docRef = doc(maintenanceCollectionRef, editingRequest.id);
                await updateDoc(docRef, { ...formData, timestamp: new Date() });
                showMessage('ูุฌุงุญ', 'ุชู ุชุญุฏูุซ ุทูุจ ุงูุฅุตูุงุญ ุจูุฌุงุญ!');
                setEditingRequest(null);
            } else {
                await addDoc(maintenanceCollectionRef, {
                    ...formData,
                    type: 'ุตูุงูุฉ ุทุงุฑุฆุฉ',
                    timestamp: new Date(),
                });
                showMessage('ูุฌุงุญ', 'ุชู ุชุณุฌูู ุทูุจ ุงูุฅุตูุงุญ ุงูุทุงุฑุฆ ุจูุฌุงุญ!');
            }
            setFormData({
                carId: '', carNumber: '', date: new Date().toISOString().split('T')[0],
                description: '', priority: 'ูุชูุณุท', status: 'ููุฏ ุงูุงูุชุธุงุฑ',
                estimatedCost: 0, actualCost: 0, signature: ''
            });
        } catch (error) {
            console.error("Error submitting emergency request:", error);
            showMessage('ุฎุทุฃ', `ูุดู ุชุณุฌูู ุทูุจ ุงูุฅุตูุงุญ ุงูุทุงุฑุฆ: ${error.message}`);
        }
    };

    const handleEditRequest = (request) => {
        setEditingRequest(request);
        setFormData(request);
    };

    const handleDeleteRequest = (requestId) => {
        showMessage(
            'ุชุฃููุฏ ุงูุญุฐู',
            'ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ุทูุจ ุงูุฅุตูุงุญ ูุฐุงุ',
            true,
            async () => {
                try {
                    const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
                    const docRef = doc(maintenanceCollectionRef, requestId);
                    await deleteDoc(docRef);
                    showMessage('ูุฌุงุญ', 'ุชู ุญุฐู ุทูุจ ุงูุฅุตูุงุญ ุจูุฌุงุญ!');
                } catch (error) {
                    console.error("Error deleting emergency request:", error);
                    showMessage('ุฎุทุฃ', `ูุดู ุญุฐู ุทูุจ ุงูุฅุตูุงุญ: ${error.message}`);
                }
            }
        );
    };

    const emergencyRequests = useContext(AppContext).maintenanceRecords.filter(rec => rec.type === 'ุตูุงูุฉ ุทุงุฑุฆุฉ');

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">ูููุฐุฌ ุทูุจ ุฅุตูุงุญ ุทุงุฑุฆ</h2>
            <form onSubmit={handleSubmit} className="space-y-4 mb-8">
                <SelectField
                    label="ุฑูู ุงูุณูุงุฑุฉ"
                    name="carId"
                    value={formData.carId}
                    onChange={handleCarSelect}
                    options={cars.map(car => ({ value: car.id, label: car.carNumber }))}
                    required
                />
                <InputField label="ุงูุชุงุฑูุฎ" name="date" type="date" value={formData.date} onChange={handleInputChange} required />
                <InputField label="ูุตู ุงูุนุทู" name="description" value={formData.description} onChange={handleInputChange} type="textarea" required />
                <SelectField
                    label="ุงูุฃููููุฉ"
                    name="priority"
                    value={formData.priority}
                    onChange={handleInputChange}
                    options={['ุนุงุฌู', 'ูุชูุณุท', 'ููุฎูุถ']}
                />
                <SelectField
                    label="ุงูุญุงูุฉ"
                    name="status"
                    value={formData.status}
                    onChange={handleInputChange}
                    options={['ููุฏ ุงูุงูุชุธุงุฑ', 'ููุฏ ุงูุฅุตูุงุญ', 'ุชู ุงูุฅุตูุงุญ', 'ุจุงูุชุธุงุฑ ูุทุน ุงูุบูุงุฑ']}
                />
                <InputField label="ุงูุชูููุฉ ุงููุชููุนุฉ (ุฑูุงู)" name="estimatedCost" type="number" value={formData.estimatedCost} onChange={handleInputChange} />
                <InputField label="ุงูุชูููุฉ ุงููุนููุฉ (ุฑูุงู)" name="actualCost" type="number" value={formData.actualCost} onChange={handleInputChange} />
                <InputField label="ุงูุชูููุน" name="signature" value={formData.signature} onChange={handleInputChange} required />

                <button
                    type="submit"
                    className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 shadow-md"
                >
                    {editingRequest ? 'ุชุญุฏูุซ ุงูุทูุจ' : 'ุฅุฑุณุงู ุทูุจ ุงูุฅุตูุงุญ'}
                </button>
                {editingRequest && (
                    <button
                        type="button"
                        onClick={() => {
                            setEditingRequest(null);
                            setFormData({
                                carId: '', carNumber: '', date: new Date().toISOString().split('T')[0],
                                description: '', priority: 'ูุชูุณุท', status: 'ููุฏ ุงูุงูุชุธุงุฑ',
                                estimatedCost: 0, actualCost: 0, signature: ''
                            });
                        }}
                        className="mr-2 px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors duration-200 shadow-md"
                    >
                        ุฅูุบุงุก ุงูุชุนุฏูู
                    </button>
                )}
            </form>

            <h3 className="text-lg font-semibold mb-4 text-gray-800">ุทูุจุงุช ุงูุฅุตูุงุญ ุงูุทุงุฑุฆุฉ ุงููุณุฌูุฉ</h3>
            {emergencyRequests.length === 0 ? (
                <p className="text-gray-600">ูุง ุชูุฌุฏ ุทูุจุงุช ุฅุตูุงุญ ุทุงุฑุฆุฉ ูุณุฌูุฉ.</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead className="bg-gray-100">
                            <tr>
                                <th className="py-3 px-4 border-b text-right">ุฑูู ุงูุณูุงุฑุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุงูุชุงุฑูุฎ</th>
                                <th className="py-3 px-4 border-b text-right">ูุตู ุงูุนุทู</th>
                                <th className="py-3 px-4 border-b text-right">ุงูุฃููููุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุงูุญุงูุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุงูุชูููุฉ ุงููุชููุนุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุงูุชูููุฉ ุงููุนููุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            {emergencyRequests.map(req => (
                                <tr key={req.id} className="hover:bg-gray-50 transition-colors duration-150">
                                    <td className="py-3 px-4 border-b">{req.carNumber}</td>
                                    <td className="py-3 px-4 border-b">{new Date(req.date).toLocaleDateString('ar-SA')}</td>
                                    <td className="py-3 px-4 border-b">{req.description}</td>
                                    <td className="py-3 px-4 border-b">{req.priority}</td>
                                    <td className="py-3 px-4 border-b">{req.status}</td>
                                    <td className="py-3 px-4 border-b">{req.estimatedCost} ุฑูุงู</td>
                                    <td className="py-3 px-4 border-b">{req.actualCost} ุฑูุงู</td>
                                    <td className="py-3 px-4 border-b">
                                        <button
                                            onClick={() => handleEditRequest(req)}
                                            className="ml-2 px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors duration-200 text-sm"
                                        >
                                            ุชุนุฏูู
                                        </button>
                                        <button
                                            onClick={() => handleDeleteRequest(req.id)}
                                            className="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 text-sm"
                                        >
                                            ุญุฐู
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};


// Monthly Maintenance Form Component
const MonthlyMaintenanceForm = () => {
    const { db, userId, cars, showMessage } = useContext(AppContext);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const [formData, setFormData] = useState({
        carId: '',
        carNumber: '',
        lastMaintenanceDate: new Date().toISOString().split('T')[0],
        maintenanceType: '', // 'ุดูุฑูุฉ', 'ุฑุจุน ุณูููุฉ', 'ุณูููุฉ'
        mileage: 0,
        tasksCompleted: '', // Comma separated string or array
        nextMaintenanceDate: '',
        notes: '',
    });

    const [editingRecord, setEditingRecord] = useState(null);

    const handleCarSelect = (e) => {
        const selectedCarId = e.target.value;
        const car = cars.find(c => c.id === selectedCarId);
        setFormData(prev => ({
            ...prev,
            carId: selectedCarId,
            carNumber: car ? car.carNumber : '',
        }));
    };

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const calculateNextMaintenanceDate = (type, lastDate, mileage) => {
        const d = new Date(lastDate);
        switch (type) {
            case 'ุดูุฑูุฉ':
                d.setMonth(d.getMonth() + 1);
                return d.toISOString().split('T')[0];
            case 'ุฑุจุน ุณูููุฉ':
                d.setMonth(d.getMonth() + 3);
                return d.toISOString().split('T')[0];
            case 'ุณูููุฉ':
                d.setFullYear(d.getFullYear() + 1);
                return d.toISOString().split('T')[0];
            default:
                return '';
        }
    };

    useEffect(() => {
        if (formData.lastMaintenanceDate && formData.maintenanceType) {
            const nextDate = calculateNextMaintenanceDate(formData.maintenanceType, formData.lastMaintenanceDate, formData.mileage);
            setFormData(prev => ({ ...prev, nextMaintenanceDate: nextDate }));
        }
    }, [formData.lastMaintenanceDate, formData.maintenanceType, formData.mileage]);


    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage('ุฎุทุฃ', 'ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ูุนุฑู ุงููุณุชุฎุฏู ุบูุฑ ูุชุงุญ.');
            return;
        }
        if (!formData.carId || !formData.lastMaintenanceDate || !formData.maintenanceType || !formData.mileage) {
            showMessage('ุฎุทุฃ', 'ุงูุฑุฌุงุก ููุก ุงูุญููู ุงููุทููุจุฉ (ุฑูู ุงูุณูุงุฑุฉุ ุชุงุฑูุฎ ุขุฎุฑ ุตูุงูุฉุ ููุน ุงูุตูุงูุฉุ ุงููุณุงูุฉ ุงูููุทูุนุฉ).');
            return;
        }

        try {
            const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
            if (editingRecord) {
                const docRef = doc(maintenanceCollectionRef, editingRecord.id);
                await updateDoc(docRef, { ...formData, timestamp: new Date() });
                showMessage('ูุฌุงุญ', 'ุชู ุชุญุฏูุซ ุณุฌู ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ ุจูุฌุงุญ!');
                setEditingRecord(null);
            } else {
                await addDoc(maintenanceCollectionRef, {
                    ...formData,
                    type: formData.maintenanceType, // Use the selected type
                    timestamp: new Date(),
                });
                showMessage('ูุฌุงุญ', 'ุชู ุชุณุฌูู ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ ุจูุฌุงุญ!');
            }
            setFormData({
                carId: '', carNumber: '', lastMaintenanceDate: new Date().toISOString().split('T')[0],
                maintenanceType: '', mileage: 0, tasksCompleted: '', nextMaintenanceDate: '', notes: ''
            });
        } catch (error) {
            console.error("Error submitting monthly maintenance:", error);
            showMessage('ุฎุทุฃ', `ูุดู ุชุณุฌูู ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ: ${error.message}`);
        }
    };

    const handleEditRecord = (record) => {
        setEditingRecord(record);
        setFormData(record);
    };

    const handleDeleteRecord = (recordId) => {
        showMessage(
            'ุชุฃููุฏ ุงูุญุฐู',
            'ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ุณุฌู ุงูุตูุงูุฉ ูุฐุงุ',
            true,
            async () => {
                try {
                    const maintenanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/maintenanceRecords`);
                    const docRef = doc(maintenanceCollectionRef, recordId);
                    await deleteDoc(docRef);
                    showMessage('ูุฌุงุญ', 'ุชู ุญุฐู ุณุฌู ุงูุตูุงูุฉ ุจูุฌุงุญ!');
                } catch (error) {
                    console.error("Error deleting maintenance record:", error);
                    showMessage('ุฎุทุฃ', `ูุดู ุญุฐู ุณุฌู ุงูุตูุงูุฉ: ${error.message}`);
                }
            }
        );
    };

    const periodicMaintenanceRecords = useContext(AppContext).maintenanceRecords.filter(rec =>
        ['ุดูุฑูุฉ', 'ุฑุจุน ุณูููุฉ', 'ุณูููุฉ'].includes(rec.type)
    );

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">ุฌุฏูู ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ</h2>
            <form onSubmit={handleSubmit} className="space-y-4 mb-8">
                <SelectField
                    label="ุฑูู ุงูุณูุงุฑุฉ"
                    name="carId"
                    value={formData.carId}
                    onChange={handleCarSelect}
                    options={cars.map(car => ({ value: car.id, label: car.carNumber }))}
                    required
                />
                <InputField label="ุชุงุฑูุฎ ุขุฎุฑ ุตูุงูุฉ" name="lastMaintenanceDate" type="date" value={formData.lastMaintenanceDate} onChange={handleInputChange} required />
                <SelectField
                    label="ููุน ุงูุตูุงูุฉ"
                    name="maintenanceType"
                    value={formData.maintenanceType}
                    onChange={handleInputChange}
                    options={['ุดูุฑูุฉ', 'ุฑุจุน ุณูููุฉ', 'ุณูููุฉ']}
                    required
                />
                <InputField label="ุงููุณุงูุฉ ุงูููุทูุนุฉ (ูู)" name="mileage" type="number" value={formData.mileage} onChange={handleInputChange} required />
                <InputField label="ุงูููุงู ุงูููุฌุฒุฉ" name="tasksCompleted" value={formData.tasksCompleted} onChange={handleInputChange} type="textarea" placeholder="ูุซุงู: ุชุบููุฑ ุฒูุช ูุญุฑูุ ููุชุฑ ููุงุก" />
                <InputField label="ุงูููุนุฏ ุงููุงุฏู" name="nextMaintenanceDate" type="date" value={formData.nextMaintenanceDate} onChange={handleInputChange} readOnly />
                <InputField label="ููุงุญุธุงุช" name="notes" value={formData.notes} onChange={handleInputChange} type="textarea" />

                <button
                    type="submit"
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md"
                >
                    {editingRecord ? 'ุชุญุฏูุซ ุงูุณุฌู' : 'ุชุณุฌูู ุงูุตูุงูุฉ'}
                </button>
                {editingRecord && (
                    <button
                        type="button"
                        onClick={() => {
                            setEditingRecord(null);
                            setFormData({
                                carId: '', carNumber: '', lastMaintenanceDate: new Date().toISOString().split('T')[0],
                                maintenanceType: '', mileage: 0, tasksCompleted: '', nextMaintenanceDate: '', notes: ''
                            });
                        }}
                        className="mr-2 px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors duration-200 shadow-md"
                    >
                        ุฅูุบุงุก ุงูุชุนุฏูู
                    </button>
                )}
            </form>

            <h3 className="text-lg font-semibold mb-4 text-gray-800">ุณุฌูุงุช ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ</h3>
            {periodicMaintenanceRecords.length === 0 ? (
                <p className="text-gray-600">ูุง ุชูุฌุฏ ุณุฌูุงุช ุตูุงูุฉ ุฏูุฑูุฉ ูุณุฌูุฉ.</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead className="bg-gray-100">
                            <tr>
                                <th className="py-3 px-4 border-b text-right">ุฑูู ุงูุณูุงุฑุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ููุน ุงูุตูุงูุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุชุงุฑูุฎ ุขุฎุฑ ุตูุงูุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุงููุณุงูุฉ (ูู)</th>
                                <th className="py-3 px-4 border-b text-right">ุงูููุงู ุงูููุฌุฒุฉ</th>
                                <th className="py-3 px-4 border-b text-right">ุงูููุนุฏ ุงููุงุฏู</th>
                                <th className="py-3 px-4 border-b text-right">ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            {periodicMaintenanceRecords.map(rec => (
                                <tr key={rec.id} className="hover:bg-gray-50 transition-colors duration-150">
                                    <td className="py-3 px-4 border-b">{rec.carNumber}</td>
                                    <td className="py-3 px-4 border-b">{rec.maintenanceType}</td>
                                    <td className="py-3 px-4 border-b">{new Date(rec.lastMaintenanceDate).toLocaleDateString('ar-SA')}</td>
                                    <td className="py-3 px-4 border-b">{rec.mileage}</td>
                                    <td className="py-3 px-4 border-b">{rec.tasksCompleted}</td>
                                    <td className="py-3 px-4 border-b">{new Date(rec.nextMaintenanceDate).toLocaleDateString('ar-SA')}</td>
                                    <td className="py-3 px-4 border-b">
                                        <button
                                            onClick={() => handleEditRecord(rec)}
                                            className="ml-2 px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors duration-200 text-sm"
                                        >
                                            ุชุนุฏูู
                                        </button>
                                        <button
                                            onClick={() => handleDeleteRecord(rec.id)}
                                            className="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 text-sm"
                                        >
                                            ุญุฐู
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// Annual Report Component
const AnnualReport = () => {
    const { cars, maintenanceRecords, showMessage } = useContext(AppContext);
    const [selectedCarId, setSelectedCarId] = useState('');
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    const [reportData, setReportData] = useState(null);

    const generateReport = () => {
        if (!selectedCarId || !selectedYear) {
            showMessage('ุฎุทุฃ', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุณูุงุฑุฉ ูุงูุณูุฉ ูุฅูุดุงุก ุงูุชูุฑูุฑ.');
            return;
        }

        const car = cars.find(c => c.id === selectedCarId);
        if (!car) {
            showMessage('ุฎุทุฃ', 'ุงูุณูุงุฑุฉ ุงููุฎุชุงุฑุฉ ุบูุฑ ููุฌูุฏุฉ.');
            return;
        }

        const yearRecords = maintenanceRecords.filter(record => {
            const recordDate = new Date(record.date || record.lastMaintenanceDate || record.timestamp.toDate());
            return record.carId === selectedCarId && recordDate.getFullYear() === selectedYear;
        });

        let totalAnnualMileage = 0;
        let totalCost = 0;
        const maintenanceCount = {
            'ุตูุงูุฉ ููููุฉ': 0,
            'ุตูุงูุฉ ุฃุณุจูุนูุฉ': 0,
            'ุดูุฑูุฉ': 0,
            'ุฑุจุน ุณูููุฉ': 0,
            'ุณูููุฉ': 0,
            'ุตูุงูุฉ ุทุงุฑุฆุฉ': 0,
        };
        const recurringFaults = {}; // { description: count }

        yearRecords.forEach(record => {
            if (record.mileage) {
                totalAnnualMileage += parseInt(record.mileage, 10);
            }
            if (record.actualCost) {
                totalCost += parseFloat(record.actualCost);
            } else if (record.estimatedCost && record.status === 'ุชู ุงูุฅุตูุงุญ') {
                totalCost += parseFloat(record.estimatedCost);
            }

            if (maintenanceCount[record.type]) {
                maintenanceCount[record.type]++;
            } else {
                maintenanceCount[record.type] = 1;
            }

            if (record.type === 'ุตูุงูุฉ ุทุงุฑุฆุฉ' && record.description) {
                recurringFaults[record.description] = (recurringFaults[record.description] || 0) + 1;
            }
        });

        const sortedRecurringFaults = Object.entries(recurringFaults)
            .filter(([, count]) => count > 1) // Only show faults that occurred more than once
            .sort((a, b) => b[1] - a[1])
            .map(([desc, count]) => `${desc} (${count} ูุฑุงุช)`);

        setReportData({
            carNumber: car.carNumber,
            annualMileage: totalAnnualMileage,
            totalMaintenanceCount: yearRecords.length,
            maintenanceBreakdown: maintenanceCount,
            totalCosts: totalCost,
            recurringFaults: sortedRecurringFaults.length > 0 ? sortedRecurringFaults.join(', ') : 'ูุง ุชูุฌุฏ ุฃุนุทุงู ูุชูุฑุฑุฉ',
            carConditionRating: 'ุฌูุฏุฉ (โญ๏ธโญ๏ธโญ๏ธโญ๏ธ)' // This would ideally be a manual input or calculated based on severity of faults
        });
    };

    const handlePrint = () => {
        const printContent = document.getElementById('annual-report-content').innerHTML;
        const originalContent = document.body.innerHTML;
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
        window.location.reload(); // Reload to restore original page
    };

    const handleShare = () => {
        // In a real application, this would generate a unique, read-only link to the report.
        // For this example, we'll just provide the current URL as a placeholder.
        const reportUrl = window.location.href; // This is the app URL, not a specific report URL
        navigator.clipboard.writeText(reportUrl)
            .then(() => showMessage('ูุฌุงุญ', 'ุชู ูุณุฎ ุฑุงุจุท ุงูุชุทุจูู ุฅูู ุงูุญุงูุธุฉ. ููููู ูุดุงุฑูุชู ูุน ุงูุขุฎุฑูู ูุนุฑุถ ุงูุชูุงุฑูุฑ (ุฅุฐุง ูุงู ูุฏููู ุตูุงุญูุฉ ุงููุตูู).'))
            .catch(() => showMessage('ุฎุทุฃ', 'ูุดู ูุณุฎ ุงูุฑุงุจุท ุฅูู ุงูุญุงูุธุฉ. ูุฑุฌู ุงููุณุฎ ูุฏูููุง.'));
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4 text-gray-800">ุชูุฑูุฑ ุตูุงูุฉ ุณููู</h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <SelectField
                    label="ุงุฎุชุฑ ุงูุณูุงุฑุฉ"
                    name="selectedCarId"
                    value={selectedCarId}
                    onChange={(e) => setSelectedCarId(e.target.value)}
                    options={cars.map(car => ({ value: car.id, label: car.carNumber }))}
                    required
                />
                <SelectField
                    label="ุงุฎุชุฑ ุงูุณูุฉ"
                    name="selectedYear"
                    value={selectedYear}
                    onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                    options={Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - i)} // Last 5 years
                    required
                />
            </div>

            <button
                onClick={generateReport}
                className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 shadow-md mb-6"
            >
                ุฅูุดุงุก ุงูุชูุฑูุฑ
            </button>

            {reportData && (
                <div id="annual-report-content" className="border border-gray-200 p-6 rounded-lg bg-gray-50 mt-8">
                    <h3 className="text-xl font-bold mb-4 text-gray-800">ุชูุฑูุฑ ุงูุตูุงูุฉ ุงูุณููู ูู {reportData.carNumber} - ุณูุฉ {selectedYear}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                        <p><strong>ุฑูู ุงูุณูุงุฑุฉ:</strong> {reportData.carNumber}</p>
                        <p><strong>ุงููุณุงูุฉ ุงูุณูููุฉ:</strong> {reportData.annualMileage} ูู</p>
                        <p><strong>ุนุฏุฏ ูุฑุงุช ุงูุตูุงูุฉ:</strong> {reportData.totalMaintenanceCount}</p>
                        <p><strong>ุงูุชูุงููู ุงูุฅุฌูุงููุฉ:</strong> {reportData.totalCosts} ุฑูุงู</p>
                        <p><strong>ุงูุฃุนุทุงู ุงููุชูุฑุฑุฉ:</strong> {reportData.recurringFaults}</p>
                        <p><strong>ุชูููู ุญุงูุฉ ุงูุณูุงุฑุฉ:</strong> {reportData.carConditionRating}</p>
                    </div>
                    <div className="mt-6">
                        <h4 className="text-lg font-semibold mb-2">ุชูุตูู ุฃููุงุน ุงูุตูุงูุฉ:</h4>
                        <ul className="list-disc list-inside text-gray-700">
                            {Object.entries(reportData.maintenanceBreakdown).map(([type, count]) => (
                                <li key={type}>{type}: {count} ูุฑุงุช</li>
                            ))}
                        </ul>
                    </div>
                    <div className="flex justify-end space-x-2 mt-6">
                        <button
                            onClick={handlePrint}
                            className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200"
                        >
                            ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                        </button>
                        <button
                            onClick={handleShare}
                            className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors duration-200"
                        >
                            ูุดุงุฑูุฉ ุงูุฑุงุจุท
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};


export default App;
